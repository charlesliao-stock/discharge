<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç—…æˆ¿å³æ™‚çœ‹æ¿ & è­·ç†é€šçŸ¥ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        body { user-select: none; touch-action: manipulation; }
        .status-normal      { background-color: #ffffff; color: #374151; border: 2px solid #e5e7eb; }
        .status-pre-discharge { background-color: #fff1f2; color: #9d174d; border: 2px solid #be185d; }
        .status-ready       { background-color: #f0fdf4; color: #166534; border: 2px solid #15803d; }
        .status-billed      { background-color: #fff7ed; color: #9a3412; border: 2px solid #ea580c; }
        .status-delayed     { background-color: #eff6ff; color: #1e40af; border: 2px solid #3b82f6; }

        .bed-card {
            transition: transform 0.1s, background-color 0.1s, border-color 0.1s;
            cursor: pointer;
            position: relative;
        }
        .bed-card:active { transform: scale(0.96); }

        /* åˆ†çµ„å®¹å™¨æ¨£å¼ */
        .group-container {
            min-height: 100px;
            background: rgba(255,255,255,0.5);
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 0.5rem;
        }
        .sortable-ghost { opacity: 0.2; background: #e5e7eb !important; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to   { transform: translateX(100%); opacity: 0; } }
        .toast-animate-in  { animation: slideIn 0.3s ease-out forwards; }
        .toast-animate-out { animation: fadeOut 0.3s ease-in  forwards; }

        .modal-overlay { background-color: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4 min-h-screen">

    <div id="toast-container" class="fixed bottom-4 right-4 z-[110] flex flex-col gap-2 w-full max-w-sm px-4"></div>

    <div id="modal-container" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-sm p-4">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3 text-center border-b pb-2">é¸å–®</h3>
            <div id="modal-content" class="space-y-2 max-h-[60vh] overflow-y-auto p-1 text-sm"></div>
            <div class="mt-4 pt-2 border-t">
                <button id="modal-close-btn" class="w-full py-2 bg-gray-100 text-gray-600 rounded-lg font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <div class="mb-4 flex flex-col sm:flex-row justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-3">
            <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                ğŸ¥ è­·ç†çœ‹æ¿
                <span id="role-badge" class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">æ§åˆ¶ç«¯</span>
            </h1>

            <div class="flex flex-wrap items-center gap-2 justify-end">
                <div class="flex bg-gray-100 p-1 rounded-lg">
                    <button id="btn-control" class="px-3 py-1 rounded text-xs font-bold transition">æ§åˆ¶</button>
                    <button id="btn-nursing" class="px-3 py-1 rounded text-xs font-bold transition">è­·ç†</button>
                    <button id="btn-clerk"   class="px-3 py-1 rounded text-xs font-bold transition">æ›¸è¨˜</button>
                </div>
                <select id="select-my-group" class="hidden border rounded p-1 text-xs font-bold bg-green-50">
                    <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
                    <option value="A">åƒ…çœ‹ A çµ„</option>
                    <option value="B">åƒ…çœ‹ B çµ„</option>
                    <option value="none">æœªåˆ†çµ„</option>
                </select>
                <button id="btn-notify-toggle" class="px-3 py-1 rounded bg-gray-200 text-gray-500 font-bold text-xs flex items-center gap-1">
                    ğŸ”• éœéŸ³
                </button>
            </div>
        </div>

        <div id="admin-panel" class="mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100 hidden">
            <div class="flex flex-wrap gap-2 items-center">
                <button id="btn-edit-mode" class="bg-gray-500 text-white px-3 py-1.5 rounded font-bold text-xs">ğŸ”’ é–å®šæ’åº</button>
                <div id="edit-tools" class="hidden flex gap-2">
                    <input type="text" id="new-bed-id" placeholder="åºŠè™Ÿ" class="border p-1 w-16 text-center rounded text-xs">
                    <button id="btn-add-bed" class="bg-blue-600 text-white px-3 py-1.5 rounded font-bold text-xs">æ–°å¢åºŠä½</button>
                </div>
                <button id="btn-clear-all" class="bg-red-100 text-red-600 border border-red-300 px-3 py-1.5 rounded font-bold text-xs">â™»ï¸ æ¸…é™¤ç‹€æ…‹</button>
            </div>
        </div>

        <div id="dashboard-content" class="space-y-6 pb-20">
            </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDmuMbCIPPZZlxxpYKiruDEdspUDtSWYjM",
    authDomain: "discharge-86653.firebaseapp.com",
    databaseURL: "https://discharge-86653-default-rtdb.firebaseio.com",
    projectId: "discharge-86653",
    storageBucket: "discharge-86653.firebasestorage.app",
    messagingSenderId: "558090656575",
    appId: "1:558090656575:web:eeadf5009dfc90bf86d18a"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// --- ç‹€æ…‹æ§åˆ¶ ---
let currentRole = 'control';
let isEditMode = false;
let isNotifyEnabled = false;
let localBeds = [];
let localMessages = {};
let myGroupFilter = 'all';

// --- ç›£è½è³‡æ–™ ---
onValue(ref(db, 'beds'), (snapshot) => {
    const data = snapshot.val() || {};
    localBeds = Object.keys(data).map(id => ({ id, ...data[id] }))
                .sort((a,b) => (a.index || 0) - (b.index || 0));
    renderDashboard();
});

onValue(ref(db, 'messages'), (snapshot) => {
    const data = snapshot.val() || {};
    // æª¢æŸ¥æ˜¯å¦æœ‰æ–°è¨Šæ¯ (ç”¨æ–¼é€šçŸ¥)
    checkNewMessages(data);
    localMessages = data;
    renderDashboard();
});

function checkNewMessages(newData) {
    if (!isNotifyEnabled) return;
    Object.keys(newData).forEach(bedId => {
        const oldMsgs = localMessages[bedId] || {};
        const newMsgs = newData[bedId] || {};
        if (Object.keys(newMsgs).length > Object.keys(oldMsgs).length) {
            // å–å¾—æœ€æ–°ä¸€å‰‡
            const latestKey = Object.keys(newMsgs).pop();
            const msg = newMsgs[latestKey];
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå·±çµ„åˆ¥çš„è¨Šæ¯
            const bed = localBeds.find(b => b.id === bedId);
            if (myGroupFilter === 'all' || (bed && bed.group === myGroupFilter)) {
                showMsgToast(bedId, msg.text);
            }
        }
    });
}

// --- ç•«é¢æ¸²æŸ“ ---
function renderDashboard() {
    const container = document.getElementById('dashboard-content');
    container.innerHTML = '';

    const groups = [
        { id: 'A', name: 'A çµ„è­·ç†å¸«' },
        { id: 'B', name: 'B çµ„è­·ç†å¸«' },
        { id: 'none', name: 'æœªåˆ†çµ„ / å¾…å‘½' }
    ];

    groups.forEach(group => {
        // å¦‚æœæ˜¯è­·ç†ç«¯ä¸”é–‹å•Ÿéæ¿¾ï¼Œéš±è—ä¸ç›¸é—œçš„çµ„
        if (currentRole === 'nursing' && myGroupFilter !== 'all' && myGroupFilter !== group.id) return;

        const section = document.createElement('div');
        section.className = "bg-white p-3 rounded-xl shadow-sm border border-gray-200";
        section.innerHTML = `
            <h2 class="text-sm font-bold text-gray-500 mb-2 flex justify-between">
                <span>ğŸ“ ${group.name}</span>
                <span class="text-[10px] opacity-50">${isEditMode ? 'å¯æ‹–æ‹‰æ’åº' : ''}</span>
            </h2>
            <div id="grid-${group.id}" data-group="${group.id}" class="group-container grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2"></div>
        `;
        container.appendChild(section);

        const grid = section.querySelector(`#grid-${group.id}`);
        const bedsInGroup = localBeds.filter(b => (b.group || 'none') === group.id);

        bedsInGroup.forEach(bed => {
            const card = createBedCard(bed);
            grid.appendChild(card);
        });

        // åˆå§‹åŒ–æ‹–æ‹‰åŠŸèƒ½ (åƒ…æ§åˆ¶ç«¯å¯æ“ä½œ)
        if (currentRole === 'control' && isEditMode) {
            new Sortable(grid, {
                group: 'shared-beds',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: (evt) => {
                    const bedId = evt.item.getAttribute('data-id');
                    const targetGroup = evt.to.getAttribute('data-group');
                    update(ref(db, `beds/${bedId}`), { group: targetGroup });
                    saveOrder();
                }
            });
        }
    });
}

function createBedCard(bed) {
    const div = document.createElement('div');
    div.setAttribute('data-id', bed.id);
    div.className = `bed-card flex flex-col items-center justify-center rounded-xl p-2 min-h-[5rem] ${getStatusClass(bed)}`;
    
    const msgCount = localMessages[bed.id] ? Object.keys(localMessages[bed.id]).length : 0;
    
    let innerHTML = `<span class="text-xl font-bold">${bed.id}</span>`;
    
    // å³ä¸Šè§’ç•™è¨€æ•¸
    if (msgCount > 0) {
        innerHTML += `
            <div class="msg-trigger absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold rounded-full w-6 h-6 flex items-center justify-center border-2 border-white shadow-md z-10 animate-pulse">
                ${msgCount}
            </div>`;
    }

    // ç‹€æ…‹æ¨™ç±¤
    if (bed.billed) innerHTML += '<span class="text-[10px] bg-orange-600 text-white px-2 rounded-full mt-1">å·²è¾¦</span>';
    else if (bed.delayed) innerHTML += `<span class="text-[10px] bg-blue-600 text-white px-2 rounded-full mt-1 truncate w-full text-center">${bed.delayReason || 'å»¶é²'}</span>`;
    else if (bed.readyForBilling) innerHTML += '<span class="text-[10px] bg-green-600 text-white px-2 rounded-full mt-1">å¯è¾¦</span>';
    else if (bed.preDischarge) innerHTML += '<span class="text-[10px] bg-pink-600 text-white px-2 rounded-full mt-1">é å‡º</span>';

    div.innerHTML = innerHTML;

    // äº‹ä»¶è™•ç†
    div.addEventListener('click', (e) => {
        if (e.target.classList.contains('msg-trigger')) {
            openMessageModal(bed.id);
        } else {
            handleBedClick(bed);
        }
    });

    return div;
}

// --- äº’å‹•é‚è¼¯ ---
function handleBedClick(bed) {
    if (isEditMode) return;
    const path = `beds/${bed.id}`;
    if (currentRole === 'control') {
        update(ref(db, path), { preDischarge: !bed.preDischarge });
    } else if (currentRole === 'nursing') {
        update(ref(db, path), { readyForBilling: !bed.readyForBilling });
    } else if (currentRole === 'clerk') {
        if (bed.readyForBilling || bed.billed) {
            update(ref(db, path), { billed: !bed.billed });
        }
    }
}

function openMessageModal(bedId) {
    const modalContent = document.getElementById('modal-content');
    document.getElementById('modal-title').innerText = `${bedId} åºŠç•™è¨€æ¿`;
    
    const msgs = localMessages[bedId] || {};
    let msgListHtml = '<div class="space-y-2 mb-4 max-h-40 overflow-y-auto bg-gray-50 p-2 rounded">';
    
    Object.keys(msgs).forEach(key => {
        const m = msgs[key];
        msgListHtml += `
            <div class="border-b pb-1">
                <span class="text-[10px] font-bold text-blue-600">[${m.sender}]</span>
                <span class="text-gray-700">${m.text}</span>
            </div>`;
    });
    if (Object.keys(msgs).length === 0) msgListHtml += '<div class="text-center text-gray-400 py-4">ç›®å‰å°šç„¡ç•™è¨€</div>';
    msgListHtml += '</div>';

    modalContent.innerHTML = msgListHtml + `
        <div class="flex gap-2">
            <input id="input-new-msg" class="flex-1 border p-2 rounded text-xs" placeholder="è¼¸å…¥è¨Šæ¯...">
            <button id="btn-submit-msg" class="bg-blue-600 text-white px-3 py-1 rounded font-bold">é€å‡º</button>
        </div>
    `;

    document.getElementById('btn-submit-msg').onclick = () => {
        const text = document.getElementById('input-new-msg').value;
        if (!text) return;
        const msgRef = push(ref(db, `messages/${bedId}`));
        set(msgRef, { text, sender: currentRole, time: Date.now() });
        openMessageModal(bedId); // åˆ·æ–°
    };

    showModal();
}

function showMsgToast(bedId, text) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast-animate-in bg-blue-800 text-white p-3 rounded-lg shadow-2xl border-l-4 border-yellow-400 mb-2';
    toast.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <div class="text-[10px] font-bold text-yellow-400">æ–°è¨Šæ¯é€šçŸ¥</div>
                <div class="text-sm font-bold">${bedId} åºŠï¼š${text}</div>
            </div>
            <button class="text-white opacity-50">âœ•</button>
        </div>
    `;
    container.appendChild(toast);
    setTimeout(() => {
        toast.classList.replace('toast-animate-in', 'toast-animate-out');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// --- è¼”åŠ©åŠŸèƒ½ ---
function saveOrder() {
    const updates = {};
    document.querySelectorAll('.bed-card').forEach((el, i) => {
        updates[`beds/${el.getAttribute('data-id')}/index`] = i;
    });
    update(ref(db), updates);
}

function getStatusClass(bed) {
    if (bed.billed) return 'status-billed';
    if (bed.delayed) return 'status-delayed';
    if (bed.readyForBilling) return 'status-ready';
    if (bed.preDischarge) return 'status-pre-discharge';
    return 'status-normal';
}

function setRole(role) {
    currentRole = role;
    document.getElementById('role-badge').innerText = role === 'control' ? 'æ§åˆ¶ç«¯' : (role === 'nursing' ? 'è­·ç†ç«¯' : 'æ›¸è¨˜ç«¯');
    document.getElementById('admin-panel').classList.toggle('hidden', role !== 'control');
    document.getElementById('select-my-group').classList.toggle('hidden', role !== 'nursing');
    renderDashboard();
}

function showModal() { document.getElementById('modal-container').classList.remove('hidden'); document.getElementById('modal-container').classList.add('flex'); }
function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }

// --- åˆå§‹åŒ–äº‹ä»¶ ---
document.getElementById('btn-control').onclick = () => setRole('control');
document.getElementById('btn-nursing').onclick = () => setRole('nursing');
document.getElementById('btn-clerk').onclick = () => setRole('clerk');
document.getElementById('modal-close-btn').onclick = closeModal;
document.getElementById('btn-edit-mode').onclick = () => {
    isEditMode = !isEditMode;
    document.getElementById('btn-edit-mode').innerText = isEditMode ? 'ğŸ”“ ç·¨è¼¯ä¸­' : 'ğŸ”’ é–å®šæ’åº';
    document.getElementById('edit-tools').classList.toggle('hidden', !isEditMode);
    renderDashboard();
};
document.getElementById('btn-notify-toggle').onclick = () => {
    isNotifyEnabled = !isNotifyEnabled;
    document.getElementById('btn-notify-toggle').innerText = isNotifyEnabled ? 'ğŸ”” é€šçŸ¥é–‹å•Ÿ' : 'ğŸ”• éœéŸ³';
    document.getElementById('btn-notify-toggle').classList.toggle('bg-green-100', isNotifyEnabled);
    document.getElementById('btn-notify-toggle').classList.toggle('text-green-700', isNotifyEnabled);
};
document.getElementById('select-my-group').onchange = (e) => {
    myGroupFilter = e.target.value;
    renderDashboard();
};
document.getElementById('btn-add-bed').onclick = () => {
    const id = document.getElementById('new-bed-id').value;
    if (id) set(ref(db, `beds/${id}`), { index: localBeds.length, group: 'none' });
};

setRole('control');
</script>
</body>
</html>
