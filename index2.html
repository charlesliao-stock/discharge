<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è­·ç†çœ‹æ¿ç³»çµ± V25</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        body { user-select: none; touch-action: manipulation; }
        .status-normal      { background-color: #ffffff; color: #374151; border: 2px solid #e5e7eb; }
        .status-pre-discharge { background-color: #fff1f2; color: #9d174d; border: 2px solid #be185d; }
        .status-ready       { background-color: #f0fdf4; color: #166534; border: 2px solid #15803d; }
        .status-billed      { background-color: #fff7ed; color: #9a3412; border: 2px solid #ea580c; }
        .status-delayed     { background-color: #eff6ff; color: #1e40af; border: 2px solid #3b82f6; }

        .bed-card { transition: transform 0.1s; cursor: pointer; position: relative; }
        .bed-card:active { transform: scale(0.96); }

        .group-container { min-height: 80px; background: rgba(255,255,255,0.4); border: 2px dashed #cbd5e1; border-radius: 0.75rem; padding: 0.5rem; }
        .sortable-ghost { opacity: 0.2; background: #e5e7eb !important; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { transform: translateX(100%); opacity: 0; } }
        .toast-animate-in { animation: slideIn 0.3s ease-out forwards; }
        .toast-animate-out { animation: fadeOut 0.3s ease-in forwards; }

        .modal-overlay { background-color: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4 min-h-screen">

    <div id="toast-container" class="fixed bottom-4 right-4 z-[110] flex flex-col gap-2 w-full max-w-sm px-4"></div>

    <div id="modal-container" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-sm p-4">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3 text-center border-b pb-2">æ¨™é¡Œ</h3>
            <div id="modal-content" class="space-y-2 max-h-[60vh] overflow-y-auto p-1 text-sm"></div>
            <div class="mt-4 pt-2 border-t flex gap-2">
                <button id="modal-close-btn" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <div class="mb-4 flex flex-col sm:flex-row justify-between items-center bg-white p-3 rounded-lg shadow-sm gap-3">
            <h1 class="text-lg font-bold text-gray-800 flex items-center gap-2">ğŸ¥ è­·ç†çœ‹æ¿</h1>
            <div class="flex flex-wrap items-center gap-2 justify-end">
                <div class="flex bg-gray-100 p-1 rounded-lg shrink-0">
                    <button id="btn-control" class="px-3 py-1 rounded text-xs font-bold transition">æ§åˆ¶</button>
                    <button id="btn-nursing" class="px-3 py-1 rounded text-xs font-bold transition">è­·ç†</button>
                    <button id="btn-clerk"   class="px-3 py-1 rounded text-xs font-bold transition">æ›¸è¨˜</button>
                </div>
                <select id="select-my-group" class="hidden border rounded p-1 text-xs font-bold bg-green-50"></select>
                <button id="btn-notify-toggle" class="px-3 py-1 rounded bg-gray-200 text-gray-500 font-bold text-xs">ğŸ”• éœéŸ³</button>
            </div>
        </div>

        <div id="admin-panel" class="mb-4 bg-blue-50 p-3 rounded-lg border border-blue-100 hidden space-y-3">
            <div class="flex flex-wrap gap-2 items-center">
                <button id="btn-edit-mode" class="bg-gray-500 text-white px-3 py-1.5 rounded font-bold text-xs">ğŸ”’ é–å®šæ’åº</button>
                <div id="edit-tools" class="hidden flex gap-2">
                    <input type="text" id="new-bed-id" placeholder="åºŠè™Ÿ" class="border p-1 w-16 text-center rounded text-xs">
                    <button id="btn-add-bed" class="bg-blue-600 text-white px-3 py-1.5 rounded font-bold text-xs">ï¼‹æ–°å¢åºŠä½</button>
                    <button id="btn-manage-groups" class="bg-indigo-600 text-white px-3 py-1.5 rounded font-bold text-xs">âš™ï¸ çµ„åˆ¥ç®¡ç†</button>
                </div>
                <button id="btn-clear-all" class="bg-red-100 text-red-600 border border-red-300 px-3 py-1.5 rounded font-bold text-xs ml-auto">â™»ï¸ æ¸…é™¤ç‹€æ…‹</button>
            </div>
        </div>

        <div id="dashboard-content" class="space-y-6 pb-20"></div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDmuMbCIPPZZlxxpYKiruDEdspUDtSWYjM",
    authDomain: "discharge-86653.firebaseapp.com",
    databaseURL: "https://discharge-86653-default-rtdb.firebaseio.com",
    projectId: "discharge-86653",
    appId: "1:558090656575:web:eeadf5009dfc90bf86d18a"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

let currentRole = 'control';
let isEditMode = false;
let isNotifyEnabled = false;
let localBeds = [];
let localMessages = {};
let localGroups = [];
let myGroupFilter = 'all';

// --- è³‡æ–™ç›£è½ ---
onValue(ref(db, 'groups'), (snap) => {
    const data = snap.val() || {};
    const groupsArray = [{ id: 'none', name: 'æœªåˆ†çµ„' }];
    Object.keys(data).forEach(id => { if (id !== 'none') groupsArray.push({ id, name: data[id] }); });
    localGroups = groupsArray;
    updateGroupSelector();
    renderDashboard();
});

onValue(ref(db, 'beds'), (snap) => {
    const data = snap.val() || {};
    // å¾è³‡æ–™åº«æŠ“å–æ™‚ä¸å†å¼·åˆ¶ä¾ index æ’åºï¼Œå¾ŒçºŒæœƒåœ¨å„çµ„å…§ä¾åºŠè™Ÿæ’åº
    localBeds = Object.keys(data).map(id => ({ id, ...data[id] }));
    renderDashboard();
});

onValue(ref(db, 'messages'), (snap) => {
    const data = snap.val() || {};
    checkNewMessages(data);
    localMessages = data;
    renderDashboard();
});

// --- æ¸²æŸ“ (åŠ å…¥æ•¸å­—æ’åºé‚è¼¯) ---
function renderDashboard() {
    const container = document.getElementById('dashboard-content');
    container.innerHTML = '';
    const activeGroupIds = localGroups.map(g => g.id);
    
    localGroups.forEach(group => {
        if (currentRole === 'nursing' && myGroupFilter !== 'all' && myGroupFilter !== group.id) return;

        const section = document.createElement('div');
        section.className = "bg-white p-3 rounded-xl shadow-sm border border-gray-200";
        section.innerHTML = `
            <h2 class="text-sm font-bold text-gray-500 mb-2 flex justify-between items-center"><span>ğŸ“ ${group.name}</span></h2>
            <div id="grid-${group.id}" data-group="${group.id}" class="group-container grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2"></div>
        `;
        container.appendChild(section);

        const grid = section.querySelector(`#grid-${group.id}`);
        
        // æ ¸å¿ƒé‚è¼¯ï¼šç¯©é¸åºŠä½ä¸¦é€²è¡Œã€ŒåºŠè™Ÿæ•¸å­—æ’åºã€
        const bedsInGroup = localBeds.filter(bed => {
            const gId = bed.group || 'none';
            return (group.id === 'none') ? (gId === 'none' || !activeGroupIds.includes(gId)) : (gId === group.id);
        }).sort((a, b) => {
            // ä½¿ç”¨ localeCompare æ­é… numeric: true é€²è¡Œè‡ªç„¶æ’åº (å¦‚ 2 < 10)
            return a.id.localeCompare(b.id, undefined, { numeric: true, sensitivity: 'base' });
        });

        bedsInGroup.forEach(bed => { grid.appendChild(createBedCard(bed)); });

        if (currentRole === 'control' && isEditMode) {
            new Sortable(grid, {
                group: 'shared-beds', animation: 150,
                onEnd: (evt) => {
                    const bedId = evt.item.getAttribute('data-id');
                    const targetGroup = evt.to.getAttribute('data-group');
                    update(ref(db, `beds/${bedId}`), { group: targetGroup });
                    // æ­¤è™•ä¸å†å‘¼å« saveOrderï¼Œå› ç‚ºæˆ‘å€‘ç¾åœ¨å¼·è¡Œç”±åºŠè™Ÿæ’åºï¼Œä¸çœ‹æ‹–æ›³é †åº
                }
            });
        }
    });
}

function createBedCard(bed) {
    const div = document.createElement('div');
    div.setAttribute('data-id', bed.id);
    div.className = `bed-card flex flex-col items-center justify-center rounded-xl p-2 min-h-[5.5rem] ${getStatusClass(bed)}`;
    
    const msgCount = localMessages[bed.id] ? Object.keys(localMessages[bed.id]).length : 0;
    let innerHTML = `<span class="text-xl font-bold">${bed.id}</span>`;
    
    if (msgCount > 0) {
        innerHTML += `<div class="msg-trigger absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold rounded-full w-6 h-6 flex items-center justify-center border-2 border-white shadow-md z-10 animate-bounce">${msgCount}</div>`;
    }

    if (isEditMode && currentRole === 'control') {
        innerHTML += `<button class="delete-bed-btn absolute -bottom-1 -right-1 bg-gray-800 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">âœ•</button>`;
    }

    if (bed.billed) innerHTML += '<span class="text-[10px] bg-orange-600 text-white px-2 rounded-full mt-1">å·²è¾¦</span>';
    else if (bed.delayed) innerHTML += `<span class="text-[10px] bg-blue-600 text-white px-2 rounded-full mt-1 truncate w-full text-center px-1">${bed.delayReason || 'å»¶é²'}</span>`;
    else if (bed.readyForBilling) innerHTML += '<span class="text-[10px] bg-green-600 text-white px-2 rounded-full mt-1">å¯è¾¦</span>';
    else if (bed.preDischarge) innerHTML += '<span class="text-[10px] bg-pink-600 text-white px-2 rounded-full mt-1">é å‡º</span>';

    div.innerHTML = innerHTML;

    let pressTimer;
    div.onmousedown = (e) => { if(e.button === 0) pressTimer = setTimeout(() => openMessageModal(bed.id), 800); };
    div.onmouseup = () => clearTimeout(pressTimer);
    div.onmouseleave = () => clearTimeout(pressTimer);
    div.ontouchstart = () => { pressTimer = setTimeout(() => openMessageModal(bed.id), 800); };
    div.ontouchend = () => clearTimeout(pressTimer);
    div.oncontextmenu = (e) => { e.preventDefault(); openMessageModal(bed.id); };

    div.onclick = (e) => {
        if (e.target.classList.contains('msg-trigger')) return openMessageModal(bed.id);
        if (e.target.classList.contains('delete-bed-btn')) return deleteBed(bed.id);
        handleBedClick(bed);
    };
    return div;
}

// --- ç•™è¨€èˆ‡ Modal ---
function openMessageModal(bedId) {
    const modalContent = document.getElementById('modal-content');
    document.getElementById('modal-title').innerText = `${bedId} ç•™è¨€æ¿`;
    const msgs = localMessages[bedId] || {};
    let html = '<div class="space-y-2 mb-4 max-h-40 overflow-y-auto bg-gray-50 p-2 rounded">';
    Object.keys(msgs).forEach(key => {
        html += `<div class="border-b pb-1"><span class="text-[10px] font-bold text-blue-600">[${msgs[key].sender}]</span> ${msgs[key].text}</div>`;
    });
    html += (Object.keys(msgs).length === 0 ? '<div class="text-center text-gray-400 py-4">å°šç„¡ç•™è¨€</div>' : '') + '</div>';
    modalContent.innerHTML = html + `<div class="flex gap-2"><input id="input-new-msg" class="flex-1 border p-2 rounded text-xs" placeholder="è¼¸å…¥è¨Šæ¯..."><button id="btn-submit-msg" class="bg-blue-600 text-white px-3 py-1 rounded font-bold">é€å‡º</button></div>`;
    
    setTimeout(() => document.getElementById('input-new-msg').focus(), 100);

    document.getElementById('btn-submit-msg').onclick = () => {
        const text = document.getElementById('input-new-msg').value.trim();
        if (text) {
            push(ref(db, `messages/${bedId}`), { text, sender: currentRole, time: Date.now() });
            openMessageModal(bedId);
        }
    };
    showModal();
}

function openGroupManager() {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').innerText = "âš™ï¸ çµ„åˆ¥ç·¨è¼¯";
    let html = `<div class="space-y-2 mb-4"><div class="flex gap-2"><input id="new-group-name" class="flex-1 border p-2 rounded" placeholder="æ–°çµ„åˆ¥"><button id="btn-add-group" class="bg-green-600 text-white px-3 py-1 rounded font-bold">æ–°å¢</button></div></div><div class="space-y-2">`;
    localGroups.forEach(g => {
        if (g.id === 'none') html += `<div class="flex items-center p-2 bg-gray-50 border rounded text-gray-400 font-bold">æœªåˆ†çµ„ (ç³»çµ±å›ºå®š)</div>`;
        else html += `<div class="flex items-center gap-2 p-2 bg-white border rounded shadow-sm"><input class="flex-1 font-bold group-edit-input p-1" data-id="${g.id}" value="${g.name}"><button class="text-red-500 group-del-btn" data-id="${g.id}">ğŸ—‘ï¸</button></div>`;
    });
    content.innerHTML = html;
    document.getElementById('btn-add-group').onclick = () => { const name = document.getElementById('new-group-name').value.trim(); if (name) { set(ref(db, `groups/group_${Date.now()}`), name); openGroupManager(); } };
    content.querySelectorAll('.group-edit-input').forEach(i => i.onchange = (e) => set(ref(db, `groups/${e.target.dataset.id}`), e.target.value));
    content.querySelectorAll('.group-del-btn').forEach(b => b.onclick = (e) => { if (confirm('åˆªé™¤çµ„åˆ¥ï¼Ÿ')) { remove(ref(db, `groups/${e.target.dataset.id}`)); openGroupManager(); } });
    showModal();
}

function deleteBed(id) { if (confirm(`åˆªé™¤ ${id} åºŠï¼Ÿ`)) { remove(ref(db, `beds/${id}`)); remove(ref(db, `messages/${id}`)); } }
function updateGroupSelector() { const sel = document.getElementById('select-my-group'); sel.innerHTML = '<option value="all">é¡¯ç¤ºå…¨éƒ¨</option>'; localGroups.forEach(g => { sel.innerHTML += `<option value="${g.id}">${g.name}</option>`; }); sel.value = myGroupFilter; }
function checkNewMessages(newData) { if (!isNotifyEnabled) return; Object.keys(newData).forEach(bedId => { if (Object.keys(newData[bedId] || {}).length > Object.keys(localMessages[bedId] || {}).length) { const bed = localBeds.find(b => b.id === bedId); if (myGroupFilter === 'all' || (bed && bed.group === myGroupFilter)) { showMsgToast(bedId, Object.values(newData[bedId]).pop().text); } } }); }
function showMsgToast(bedId, text) { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = 'toast-animate-in bg-blue-800 text-white p-3 rounded-lg shadow-xl border-l-4 border-yellow-400 mb-2'; toast.innerHTML = `<div class="text-[10px] font-bold text-yellow-400">æ–°ç•™è¨€</div><div class="text-sm font-bold">${bedId}ï¼š${text}</div>`; container.appendChild(toast); setTimeout(() => { toast.classList.replace('toast-animate-in', 'toast-animate-out'); setTimeout(() => toast.remove(), 300); }, 3000); }
function handleBedClick(bed) { if (isEditMode) return; const path = `beds/${bed.id}`; if (currentRole === 'control') update(ref(db, path), { preDischarge: !bed.preDischarge }); else if (currentRole === 'nursing') update(ref(db, path), { readyForBilling: !bed.readyForBilling }); else if (currentRole === 'clerk' && (bed.readyForBilling || bed.billed)) update(ref(db, path), { billed: !bed.billed }); }
function setRole(role) { currentRole = role; const colors = { control: 'blue', nursing: 'green', clerk: 'orange' }; ['control', 'nursing', 'clerk'].forEach(r => { document.getElementById(`btn-${r}`).className = `px-3 py-1 rounded text-xs font-bold transition ${r === role ? 'bg-'+colors[r]+'-500 text-white' : 'bg-white text-gray-500'}`; }); document.getElementById('admin-panel').classList.toggle('hidden', role !== 'control'); document.getElementById('select-my-group').classList.toggle('hidden', role !== 'nursing'); renderDashboard(); }
function getStatusClass(bed) { if (bed.billed) return 'status-billed'; if (bed.delayed) return 'status-delayed'; if (bed.readyForBilling) return 'status-ready'; if (bed.preDischarge) return 'status-pre-discharge'; return 'status-normal'; }
function showModal() { document.getElementById('modal-container').classList.remove('hidden'); document.getElementById('modal-container').classList.add('flex'); }
function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }

document.getElementById('btn-control').onclick = () => setRole('control');
document.getElementById('btn-nursing').onclick = () => setRole('nursing');
document.getElementById('btn-clerk').onclick = () => setRole('clerk');
document.getElementById('modal-close-btn').onclick = closeModal;
document.getElementById('select-my-group').onchange = (e) => { myGroupFilter = e.target.value; renderDashboard(); };
document.getElementById('btn-manage-groups').onclick = openGroupManager;
document.getElementById('btn-add-bed').onclick = () => { const id = document.getElementById('new-bed-id').value.trim(); if (id) { set(ref(db, `beds/${id}`), { group: 'none' }); document.getElementById('new-bed-id').value = ''; } };
document.getElementById('btn-edit-mode').onclick = () => { isEditMode = !isEditMode; document.getElementById('btn-edit-mode').innerText = isEditMode ? 'ğŸ”“ ç·¨è¼¯ä¸­' : 'ğŸ”’ é–å®šæ’åº'; document.getElementById('edit-tools').classList.toggle('hidden', !isEditMode); renderDashboard(); };
document.getElementById('btn-notify-toggle').onclick = () => { isNotifyEnabled = !isNotifyEnabled; document.getElementById('btn-notify-toggle').innerText = isNotifyEnabled ? 'ğŸ”” é€šçŸ¥é–‹' : 'ğŸ”• éœéŸ³'; document.getElementById('btn-notify-toggle').classList.toggle('bg-green-100', isNotifyEnabled); };

setRole('control');
</script>
</body>
</html>
