<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç—…æˆ¿å‡ºé™¢å³æ™‚çœ‹æ¿ (V17-ç²¾ç°¡é˜²å‘†ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        body { user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }
        
        .status-normal { background-color: #ffffff; color: #374151; border: 2px solid #e5e7eb; }
        .status-pre-discharge { background-color: #fff1f2; color: #9d174d; border: 2px solid #be185d; }
        .status-ready { background-color: #f0fdf4; color: #166534; border: 2px solid #15803d; }
        .status-billed { background-color: #fff7ed; color: #9a3412; border: 2px solid #ea580c; }
        .status-delayed { background-color: #eff6ff; color: #1e40af; border: 2px solid #3b82f6; }
        
        .bed-card {
            transition: transform 0.1s, background-color 0.1s, border-color 0.1s; 
            cursor: pointer; touch-action: none; -webkit-user-drag: none; box-sizing: border-box;
            position: relative;
        }
        .bed-card:active { transform: scale(0.96); }

        .separator-card {
            width: 100%; height: 16px; margin: 2px 0;
            display: flex; align-items: center; justify-content: center;
            cursor: grab;
        }

        .sortable-ghost { opacity: 0.2 !important; background: #e5e7eb !important; border: 2px dashed #9ca3af !important; }
        .sortable-drag { cursor: grabbing; opacity: 1 !important; background: #ffffff; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.25); transform: scale(1.05); z-index: 9999 !important; }
        
        /* ç•¶ä¸åœ¨ç·¨è¼¯æ¨¡å¼æ™‚ï¼Œéš±è—æ‹–æ›³æ¸¸æ¨™ */
        .cursor-locked { cursor: default !important; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { transform: translateX(100%); opacity: 0; } }
        .toast-animate-in { animation: slideIn 0.3s ease-out forwards; }
        .toast-animate-out { animation: fadeOut 0.3s ease-in forwards; }
        .toast-card { cursor: pointer; transition: transform 0.1s; }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ (è®“åŠŸèƒ½åˆ—æ›´ç¾è§€) */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4 min-h-screen">

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 w-full max-w-sm px-4 sm:px-0"></div>

    <div id="modal-container" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-sm p-4 transform transition-all scale-100">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3 text-center border-b pb-2">é¸å–®</h3>
            <div id="modal-content" class="space-y-2 max-h-[50vh] overflow-y-auto p-1 custom-scrollbar"></div>
            <div class="mt-4 pt-2 border-t flex justify-center">
                <button onclick="closeModal()" class="w-full py-2 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <div class="mb-2 flex flex-col sm:flex-row justify-between items-center bg-white p-2 rounded-lg shadow-sm gap-2">
            <h1 class="text-base sm:text-lg font-bold text-gray-800 flex items-center gap-2 whitespace-nowrap">
                ğŸ¥ çœ‹æ¿ 
                <span id="role-badge" class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">æ§åˆ¶ç«¯</span>
            </h1>
            
            <div class="flex flex-nowrap overflow-x-auto no-scrollbar items-center gap-2 w-full sm:w-auto px-1">
                <div class="flex bg-gray-100 p-1 rounded-lg shrink-0">
                    <button onclick="setRole('control')" id="btn-control" class="px-3 py-1 rounded text-xs font-bold shadow transition whitespace-nowrap">æ§åˆ¶</button>
                    <button onclick="setRole('nursing')" id="btn-nursing" class="px-3 py-1 rounded text-xs font-bold shadow transition whitespace-nowrap">è­·ç†</button>
                    <button onclick="setRole('clerk')" id="btn-clerk" class="px-3 py-1 rounded text-xs font-bold shadow transition whitespace-nowrap">æ›¸è¨˜</button>
                </div>
                <button onclick="toggleNotify()" id="btn-notify-toggle" class="shrink-0 px-3 py-1 rounded bg-gray-200 text-gray-500 border border-gray-300 font-bold text-xs hover:bg-gray-300 transition flex items-center gap-1 whitespace-nowrap">
                    ğŸ”• éœéŸ³
                </button>
            </div>
        </div>

        <div id="admin-panel" class="mb-2 bg-blue-50 p-2 rounded-lg border border-blue-100 shadow-sm hidden">
            <div class="flex flex-nowrap items-center gap-2 overflow-x-auto no-scrollbar w-full">
                
                <div class="flex items-center gap-2 shrink-0 border-r border-blue-200 pr-2 mr-1">
                    <span class="text-xl">âš™ï¸</span>
                    <button onclick="toggleEditMode()" id="btn-edit-mode" class="bg-gray-500 text-white px-3 py-1.5 rounded-md font-bold shadow text-xs hover:bg-gray-600 transition flex items-center gap-1 whitespace-nowrap">
                        ğŸ”’ é–å®šä¸­
                    </button>
                </div>

                <div id="edit-tools" class="flex items-center gap-2 hidden shrink-0">
                    <input type="text" id="new-bed-id" placeholder="åºŠè™Ÿ" 
                           class="border p-1.5 rounded w-16 text-center focus:ring-2 focus:ring-blue-400 outline-none text-xs"
                           onkeydown="if(event.key === 'Enter') addBed()">
                    
                    <button onclick="addBed()" class="bg-blue-600 text-white px-3 py-1.5 rounded font-bold shadow text-xs whitespace-nowrap hover:bg-blue-700">æ–°å¢</button>
                    <button onclick="addSeparator()" class="bg-gray-500 text-white px-3 py-1.5 rounded font-bold shadow text-xs whitespace-nowrap hover:bg-gray-600">â¬‡ï¸ æ›è¡Œ</button>
                </div>

                <div class="flex items-center gap-2 shrink-0">
                     <button onclick="openReasonConfig()" class="bg-indigo-100 text-indigo-700 border border-indigo-300 px-3 py-1.5 rounded font-bold hover:bg-indigo-200 shadow text-xs whitespace-nowrap">ğŸ“ åŸå› </button>
                     <button onclick="clearAllStatuses()" class="bg-red-100 text-red-600 border border-red-300 px-3 py-1.5 rounded font-bold hover:bg-red-200 shadow text-xs whitespace-nowrap transition">â™»ï¸ é‡ç½®</button>
                </div>
            </div>
        </div>

        <div id="nursing-panel" class="mb-2 bg-green-50 p-2 rounded-lg border border-green-100 shadow-sm hidden">
            <div class="flex items-center gap-2">
                <span class="text-xl">ğŸ‘©â€âš•ï¸</span>
                <div class="text-xs text-gray-700">
                    <span class="font-bold">è­·ç†å€ï¼š</span>é»æ“Š <span class="text-green-600 font-bold">â—</span> å®Œæˆã€‚<span class="text-blue-600 font-bold">é•·æŒ‰/å³éµ</span> æ¨™è¨˜å»¶é²ã€‚
                </div>
            </div>
        </div>

        <div id="clerk-panel" class="mb-2 bg-orange-50 p-2 rounded-lg border border-orange-100 shadow-sm hidden">
            <div class="flex items-center gap-2">
                <span class="text-xl">ğŸ“</span>
                <div class="text-xs text-gray-700">
                    <span class="font-bold">æ›¸è¨˜å€ï¼š</span>é»æ“Šæ©˜è‰²æ¨™è¨˜å·²è¾¦ç†ã€‚
                </div>
            </div>
        </div>

        <div id="bed-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 content-start min-h-[200px] pb-20">
            <div class="col-span-full text-center text-gray-400 py-10">è³‡æ–™è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmuMbCIPPZZlxxpYKiruDEdspUDtSWYjM",
            authDomain: "discharge-86653.firebaseapp.com",
            databaseURL: "https://discharge-86653-default-rtdb.firebaseio.com",
            projectId: "discharge-86653",
            storageBucket: "discharge-86653.firebasestorage.app",
            messagingSenderId: "558090656575",
            appId: "1:558090656575:web:eeadf5009dfc90bf86d18a",
            measurementId: "G-5QXDZJ0T1S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentRole = 'control'; 
        let sortableInstance = null;
        let localBedList = [];
        let isDragging = false; 
        let lastBedStates = {}; 
        let isFirstLoad = true;
        let isNotifyEnabled = false; 
        let flashInterval = null;
        const originalTitle = document.title;
        let isFlashing = false;
        
        // ç·¨è¼¯æ¨¡å¼ç‹€æ…‹ (é è¨­é—œé–‰)
        let isEditMode = false;

        const defaultReasons = ["ç­‰å¾…å®¶å±¬", "ç­‰å¾…æª¢æŸ¥å ±å‘Š", "å¸³å‹™å•é¡Œ", "ç—…æƒ…è®ŠåŒ–", "ç­‰å¾…æ•‘è­·è»Š", "å…¶ä»–"];

        const bedsRef = ref(db, 'beds');
        onValue(bedsRef, (snapshot) => {
            if (isDragging) return;
            const data = snapshot.val() || {};
            
            localBedList = Object.keys(data).map(key => ({
                id: key,
                ...data[key],
                preDischarge: !!data[key].preDischarge,
                readyForBilling: !!data[key].readyForBilling,
                billed: !!data[key].billed,
                delayed: !!data[key].delayed, 
                delayReason: data[key].delayReason || "", 
                index: data[key].index !== undefined ? Number(data[key].index) : 9999
            })).sort((a, b) => {
                if (a.index !== b.index) return a.index - b.index;
                return a.id.localeCompare(b.id, undefined, { numeric: true });
            });
            
            checkAndNotify(localBedList); 
            renderGrid();
        });

        let reasonList = [];
        const reasonsRef = ref(db, 'reasons');
        onValue(reasonsRef, (snapshot) => {
            const val = snapshot.val();
            reasonList = val ? val : defaultReasons;
            if(!val) set(reasonsRef, defaultReasons);
        });

        document.addEventListener('visibilitychange', () => { if (!document.hidden) stopTitleFlash(); });

        // åˆ‡æ›ç·¨è¼¯æ¨¡å¼
        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('btn-edit-mode');
            const tools = document.getElementById('edit-tools');
            
            if (isEditMode) {
                btn.innerHTML = 'ğŸ”“ ç·¨è¼¯ä¸­';
                btn.className = 'bg-yellow-500 text-white px-3 py-1.5 rounded-md font-bold shadow text-xs hover:bg-yellow-600 transition flex items-center gap-1 whitespace-nowrap';
                tools.classList.remove('hidden');
            } else {
                btn.innerHTML = 'ğŸ”’ é–å®šä¸­';
                btn.className = 'bg-gray-500 text-white px-3 py-1.5 rounded-md font-bold shadow text-xs hover:bg-gray-600 transition flex items-center gap-1 whitespace-nowrap';
                tools.classList.add('hidden');
            }
            
            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–° Sortable ç‹€æ…‹ (å•Ÿç”¨/åœç”¨æ‹–æ›³)
            renderGrid();
        }

        window.toggleNotify = function() {
            isNotifyEnabled = !isNotifyEnabled;
            const btn = document.getElementById('btn-notify-toggle');
            if (isNotifyEnabled) {
                btn.innerHTML = 'ğŸ”” é€šçŸ¥ï¼šé–‹å•Ÿ';
                btn.className = 'shrink-0 px-3 py-1 rounded bg-green-100 text-green-700 border border-green-300 font-bold text-xs hover:bg-green-200 transition flex items-center gap-1 whitespace-nowrap';
            } else {
                btn.innerHTML = 'ğŸ”• éœéŸ³';
                btn.className = 'shrink-0 px-3 py-1 rounded bg-gray-200 text-gray-500 border border-gray-300 font-bold text-xs hover:bg-gray-300 transition flex items-center gap-1 whitespace-nowrap';
                stopTitleFlash();
            }
        }

        function checkAndNotify(beds) {
            if (isFirstLoad) {
                beds.forEach(bed => { lastBedStates[bed.id] = bed.readyForBilling; });
                isFirstLoad = false;
                return;
            }
            if (!isNotifyEnabled) {
                beds.forEach(bed => { lastBedStates[bed.id] = bed.readyForBilling; });
                return;
            }
            let hasNewNotification = false;
            beds.forEach(bed => {
                if (bed.readyForBilling === true && lastBedStates[bed.id] !== true) {
                    showToast(bed.id);
                    hasNewNotification = true;
                }
                lastBedStates[bed.id] = bed.readyForBilling;
            });
            if (hasNewNotification && document.hidden) startTitleFlash();
        }

        function startTitleFlash() {
            if (isFlashing) return;
            isFlashing = true;
            let showAlert = true;
            flashInterval = setInterval(() => {
                document.title = showAlert ? "ğŸ””ã€æœ‰æ–°é€šçŸ¥ã€‘" : originalTitle;
                showAlert = !showAlert;
            }, 1000);
        }

        function stopTitleFlash() {
            clearInterval(flashInterval);
            document.title = originalTitle;
            isFlashing = false;
        }

        function showToast(bedId) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = "toast-card toast-animate-in bg-green-600 text-white px-4 py-3 rounded-lg shadow-xl flex items-center justify-between gap-3 border border-green-400 w-full";
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-xl">ğŸ””</span>
                    <div>
                        <div class="text-xs font-light opacity-90">è­·ç†ç«™é€šçŸ¥</div>
                        <div class="text-lg font-bold">${bedId} å¯è¾¦å‡ºé™¢</div>
                    </div>
                </div>
                <div class="text-green-200 text-lg font-bold px-2">âœ•</div>
            `;
            toast.onclick = () => {
                toast.classList.remove('toast-animate-in');
                toast.classList.add('toast-animate-out');
                setTimeout(() => toast.remove(), 300);
            };
            container.appendChild(toast);
        }

        function renderGrid() {
            const grid = document.getElementById('bed-grid');
            grid.innerHTML = '';
            
            if (localBedList.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">ç›®å‰ç„¡è³‡æ–™ï¼Œè«‹ç”±æ§åˆ¶ç«¯æ–°å¢ã€‚</div>';
                return;
            }

            localBedList.forEach(bed => {
                const div = document.createElement('div');
                div.setAttribute('data-id', bed.id);

                if (bed.type === 'separator') {
                    div.className = 'separator-card col-span-full';
                    if (currentRole === 'control' && isEditMode) { // åªæœ‰ç·¨è¼¯æ¨¡å¼æ‰é¡¯ç¤ºåˆªé™¤æç¤º
                        div.innerHTML = '<div class="w-full border-b-2 border-dashed border-gray-300 text-center text-xs text-gray-400 leading-[0.1em] pointer-events-none"><span class="bg-gray-100 px-2">æ›è¡Œ (é›™æ“Šåˆªé™¤)</span></div>';
                        div.ondblclick = (e) => { e.stopPropagation(); deleteBed(bed.id); };
                        div.classList.remove('cursor-default');
                    } else {
                        div.innerHTML = '<div class="w-full h-2"></div>'; 
                        div.classList.add('cursor-default');
                    }
                } else {
                    let cardClass = `bed-card flex flex-col items-center justify-center rounded-xl shadow-sm min-h-[5rem] sm:min-h-[6rem] ${getStatusClass(bed)}`;
                    if (bed.preDischarge || bed.readyForBilling || bed.billed || bed.delayed) cardClass += " shadow-md transform scale-[1.02]"; 
                    
                    div.className = cardClass;
                    div.innerHTML = `<span class="text-xl sm:text-2xl font-bold pointer-events-none">${bed.id}</span>`; 
                    
                    if(bed.billed) {
                         div.innerHTML += `<span class="text-[10px] sm:text-xs font-bold bg-orange-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">å·²è¾¦å‡ºé™¢</span>`;
                    } else if (bed.delayed) {
                        div.innerHTML += `<span class="text-[10px] sm:text-xs font-bold bg-blue-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none truncate max-w-[90%]">${bed.delayReason || 'å»¶é²'}</span>`;
                    } else if(bed.readyForBilling) {
                        div.innerHTML += `<span class="text-[10px] sm:text-xs font-bold bg-green-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">å¯è¾¦å‡ºé™¢</span>`;
                    } else if (bed.preDischarge) {
                        div.innerHTML += `<span class="text-[10px] sm:text-xs font-bold bg-pink-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">é å‡ºé™¢</span>`;
                    }

                    attachBedEvents(div, bed);
                    
                    // é›™æ“Šåˆªé™¤ï¼šåªæœ‰åœ¨æ§åˆ¶ç«¯ä¸”é–‹å•Ÿç·¨è¼¯æ¨¡å¼æ™‚æ‰å…è¨±
                    if (currentRole === 'control' && isEditMode && !bed.preDischarge && !bed.readyForBilling && !bed.billed && !bed.delayed) {
                         div.ondblclick = (e) => { e.stopPropagation(); deleteBed(bed.id); };
                         div.title = "é›™æ“Šåˆªé™¤ / æ‹–æ›³æ’åº";
                    } else {
                        div.title = "";
                    }
                }
                grid.appendChild(div);
            });
            initSortable();
        }

        function attachBedEvents(element, bed) {
            let pressTimer;
            let isLongPress = false;

            element.onmousedown = function(e) {
                if(e.button !== 0) return; 
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    handleLongPress(bed);
                }, 800); 
            };
            element.onmouseup = function() { clearTimeout(pressTimer); };
            
            element.oncontextmenu = function(e) {
                e.preventDefault(); 
                if (currentRole === 'nursing') {
                    openReasonModal(bed); 
                }
                return false;
            };
            
            element.onclick = function() {
                if (!isLongPress) handleShortClick(bed);
            };

            element.ontouchstart = function() {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    handleLongPress(bed);
                }, 800);
            };
            element.ontouchend = function() { clearTimeout(pressTimer); };
        }

        function handleShortClick(bed) {
            if (isDragging) return; 
            
            if (bed.delayed) {
                if (currentRole === 'nursing' || currentRole === 'control') {
                    if (confirm(`è§£é™¤ã€Œ${bed.id}ã€çš„å»¶é²ç‹€æ…‹ï¼Ÿ`)) {
                        update(ref(db, `beds/${bed.id}`), { delayed: false, delayReason: "" });
                    }
                }
                return;
            }

            const updates = {};
            if (currentRole === 'control') {
                updates[`/beds/${bed.id}/preDischarge`] = !bed.preDischarge;
            } 
            else if (currentRole === 'nursing') {
                updates[`/beds/${bed.id}/readyForBilling`] = !bed.readyForBilling;
                if (bed.readyForBilling) updates[`/beds/${bed.id}/billed`] = false; 
            }
            else if (currentRole === 'clerk') {
                if (!bed.readyForBilling && !bed.billed) {
                    alert("ç„¡æ³•æ¨™è¨˜ï¼šè­·ç†ç«¯å°šæœªç¢ºèªå¯è¾¦å‡ºé™¢");
                    return;
                }
                updates[`/beds/${bed.id}/billed`] = !bed.billed;
            }
            update(ref(db), updates);
        }

        function handleLongPress(bed) {
            if (currentRole !== 'nursing') return;
            if (navigator.vibrate) navigator.vibrate(50);
            openReasonModal(bed);
        }

        window.openReasonModal = function(bed) {
            const modal = document.getElementById('modal-container');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            title.innerText = `${bed.id} å»¶é²åŸå› `;
            content.innerHTML = '';
            reasonList.forEach(reason => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 text-blue-800 font-bold mb-2 active:bg-blue-200 transition";
                btn.innerText = reason;
                btn.onclick = () => {
                    update(ref(db, `beds/${bed.id}`), { delayed: true, delayReason: reason });
                    closeModal();
                };
                content.appendChild(btn);
            });
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.openReasonConfig = function() {
            const modal = document.getElementById('modal-container');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            title.innerText = "ç·¨è¼¯åŸå› ";
            content.innerHTML = '<div class="mb-4 flex gap-2"><input id="new-reason-input" class="border p-2 rounded flex-grow" placeholder="æ–°åŸå› "><button onclick="addNewReason()" class="bg-green-500 text-white px-3 py-2 rounded font-bold">æ–°å¢</button></div>';
            const listDiv = document.createElement('div');
            listDiv.className = "space-y-2";
            reasonList.forEach((reason, index) => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center bg-gray-50 p-3 rounded-lg border";
                row.innerHTML = `<span class="font-bold text-gray-700">${reason}</span><button onclick="removeReason(${index})" class="text-red-500 font-bold px-2 py-1 bg-red-50 rounded hover:bg-red-100">åˆªé™¤</button>`;
                listDiv.appendChild(row);
            });
            content.appendChild(listDiv);
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.addNewReason = function() {
            const input = document.getElementById('new-reason-input');
            const val = input.value.trim();
            if(val) {
                const newList = [...reasonList, val];
                set(ref(db, 'reasons'), newList);
                openReasonConfig(); 
            }
        }

        window.removeReason = function(index) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤åŸå› ï¼Ÿ")) {
                const newList = reasonList.filter((_, i) => i !== index);
                set(ref(db, 'reasons'), newList);
                openReasonConfig(); 
            }
        }

        window.closeModal = function() {
            document.getElementById('modal-container').classList.add('hidden');
            document.getElementById('modal-container').classList.remove('flex');
        }

        function initSortable() {
            const grid = document.getElementById('bed-grid');
            if (sortableInstance) sortableInstance.destroy();

            // åªæœ‰åœ¨æ§åˆ¶ç«¯ ä¸” ç·¨è¼¯æ¨¡å¼é–‹å•Ÿæ™‚ï¼Œæ‰å…è¨±æ‹–æ›³
            if (currentRole === 'control' && isEditMode) {
                sortableInstance = new Sortable(grid, {
                    animation: 150, forceFallback: true, fallbackOnBody: true, fallbackClass: "sortable-drag", ghostClass: "sortable-ghost", delay: 50, delayOnTouchOnly: true, multiDrag: false,
                    onStart: function() { isDragging = true; },
                    onEnd: function (evt) { isDragging = false; saveNewOrder(); }
                });
                grid.classList.remove('cursor-locked');
            } else {
                grid.classList.add('cursor-locked');
            }
        }

        function saveNewOrder() {
            const grid = document.getElementById('bed-grid');
            const items = grid.querySelectorAll('[data-id]');
            const updates = {};
            items.forEach((item, index) => {
                updates[`/beds/${item.getAttribute('data-id')}/index`] = Number(index);
            });
            update(ref(db), updates);
        }

        function getStatusClass(bed) {
            if (bed.billed) return 'status-billed';
            if (bed.delayed) return 'status-delayed'; 
            if (bed.readyForBilling) return 'status-ready';
            if (bed.preDischarge) return 'status-pre-discharge';
            return 'status-normal';
        }

        window.clearAllStatuses = function() {
            if(!confirm("ç¢ºå®šè¦æ¸…é™¤ã€Œæ‰€æœ‰ã€ç‹€æ…‹é¡è‰²ï¼Ÿ")) return;
            const updates = {};
            localBedList.forEach(bed => {
                if (bed.type === 'separator') return;
                updates[`/beds/${bed.id}/preDischarge`] = false;
                updates[`/beds/${bed.id}/readyForBilling`] = false;
                updates[`/beds/${bed.id}/billed`] = false;
                updates[`/beds/${bed.id}/delayed`] = false;
                updates[`/beds/${bed.id}/delayReason`] = "";
            });
            update(ref(db), updates);
        }

        window.addBed = function() {
            const input = document.getElementById('new-bed-id');
            const id = input.value.trim();
            if (!id) return;
            const maxIndex = localBedList.length > 0 ? Math.max(...localBedList.map(b => Number(b.index) || 0)) : 0;
            set(ref(db, 'beds/' + id), { 
                type: 'bed', preDischarge: false, readyForBilling: false, billed: false, delayed: false, delayReason: "", index: maxIndex + 1 
            });
            input.value = ''; input.focus(); 
        }

        window.addSeparator = function() {
            const maxIndex = localBedList.length > 0 ? Math.max(...localBedList.map(b => Number(b.index) || 0)) : 0;
            const sepId = 'SEP_' + Date.now();
            set(ref(db, 'beds/' + sepId), { type: 'separator', index: maxIndex + 1 });
        }

        window.deleteBed = function(id) {
            const isSep = id.startsWith('SEP_');
            if(confirm(isSep ? 'ç§»é™¤æ­¤æ›è¡Œåˆ†éš”ç·šï¼Ÿ' : `åˆªé™¤åºŠè™Ÿ ${id}ï¼Ÿ`)) remove(ref(db, 'beds/' + id));
        }

        window.setRole = function(role) {
            currentRole = role;
            ['control', 'nursing', 'clerk'].forEach(r => {
                const btn = document.getElementById(`btn-${r}`);
                if(r === role) {
                    btn.className = `px-3 py-1 rounded text-white font-bold shadow transition text-xs whitespace-nowrap ${r === 'control'?'bg-blue-500': r==='nursing'?'bg-green-500':'bg-orange-500'}`;
                    document.getElementById('role-badge').innerText = btn.innerText;
                    document.getElementById('role-badge').className = `text-xs px-2 py-1 rounded ${r === 'control'?'bg-blue-100 text-blue-800': r==='nursing'?'bg-green-100 text-green-800':'bg-orange-100 text-orange-800'}`;
                } else {
                    btn.className = "px-3 py-1 rounded bg-white text-gray-500 shadow transition hover:bg-gray-100 text-xs whitespace-nowrap";
                }
            });
            document.getElementById('admin-panel').classList.toggle('hidden', role !== 'control');
            document.getElementById('nursing-panel').classList.toggle('hidden', role !== 'nursing');
            document.getElementById('clerk-panel').classList.toggle('hidden', role !== 'clerk');
            
            // åˆ‡æ›è§’è‰²æ™‚ï¼Œå¦‚æœæ˜¯æ§åˆ¶ç«¯è¦æª¢æŸ¥ç·¨è¼¯æ¨¡å¼æ˜¯å¦é–‹å•Ÿï¼Œå…¶ä»–ç«¯å‰‡å¼·åˆ¶é—œé–‰æ‹–æ›³
            renderGrid();
        }

        function checkUrlAndInit() {
            const params = new URLSearchParams(window.location.search);
            const v = params.get('v');
            if (v === '2') {
                setRole('nursing');
            } else if (v === '3') {
                setRole('clerk');
            } else {
                setRole('control');
            }
        }
        checkUrlAndInit();
    </script>
</body>
</html>
