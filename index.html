<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…æˆ¿å‡ºé™¢å³æ™‚çœ‹æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç‹€æ…‹é¡è‰²å®šç¾© */
        .status-normal { background-color: #f3f4f6; color: #374151; } /* ç°è‰²é è¨­ */
        .status-pre-discharge { background-color: #fbcfe8; color: #831843; border: 2px solid #db2777; } /* æ·¡ç²‰ç´… (é å‡ºé™¢) */
        .status-ready { background-color: #bbf7d0; color: #14532d; border: 2px solid #16a34a; } /* æ·¡ç¶  (å¯è¾¦æ‰‹çºŒ) */
        
        .bed-card {
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
        }
        .bed-card:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-100 p-6">

    <div class="max-w-4xl mx-auto">
        <div class="mb-6 flex justify-between items-center bg-white p-4 rounded shadow">
            <h1 class="text-xl font-bold text-gray-800">å‡ºé™¢å‹•æ…‹çœ‹æ¿</h1>
            <div class="flex gap-2">
                <button onclick="setRole('control')" id="btn-control" class="px-4 py-2 rounded bg-blue-500 text-white font-bold">æˆ‘æ˜¯æ§åˆ¶ç«¯ (é†«ç”Ÿ/æ›¸è¨˜)</button>
                <button onclick="setRole('nursing')" id="btn-nursing" class="px-4 py-2 rounded bg-gray-200 text-gray-700">æˆ‘æ˜¯è­·ç†ç«¯ (è­·ç†ç«™)</button>
            </div>
        </div>

        <div id="admin-panel" class="mb-6 bg-white p-4 rounded shadow hidden">
            <h2 class="font-bold mb-2 text-gray-700">âš™ï¸ åºŠè™Ÿç®¡ç† (æ§åˆ¶ç«¯åŠŸèƒ½)</h2>
            <div class="flex gap-2">
                <input type="text" id="new-bed-id" placeholder="è¼¸å…¥åºŠè™Ÿ (ä¾‹: 01)" class="border p-2 rounded w-32 text-center">
                <button onclick="addBed()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">æ–°å¢åºŠè™Ÿ</button>
            </div>
            <p class="text-xs text-gray-500 mt-2">* é»é¸ä¸‹æ–¹åºŠè™Ÿå¯æ¨™è¨˜ã€Œé å‡ºé™¢ã€(ç²‰ç´…)</p>
            <p class="text-xs text-red-500 mt-1">* é›™æ“ŠåºŠè™Ÿå¯åˆªé™¤ (åƒ…é™ç„¡ç‹€æ…‹æ™‚)</p>
        </div>

        <div id="nursing-panel" class="mb-6 bg-white p-4 rounded shadow hidden">
            <h2 class="font-bold mb-2 text-gray-700">ğŸ‘©â€âš•ï¸ è­·ç†ä½œæ¥­å€</h2>
            <p class="text-sm text-gray-600">é»é¸ç²‰ç´…è‰²åºŠè™Ÿï¼Œæ¨™è¨˜ç‚ºã€Œå®Œæˆ/å¯è¾¦å‡ºé™¢ã€(è®Šç¶ )ã€‚</p>
        </div>

        <div id="bed-grid" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-4">
            <div class="col-span-full text-center text-gray-400 py-8">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ä½ çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDmuMbCIPPZZlxxpYKiruDEdspUDtSWYjM",
            authDomain: "discharge-86653.firebaseapp.com",
            databaseURL: "https://discharge-86653-default-rtdb.firebaseio.com",
            projectId: "discharge-86653",
            storageBucket: "discharge-86653.firebasestorage.app",
            messagingSenderId: "558090656575",
            appId: "1:558090656575:web:eeadf5009dfc90bf86d18a",
            measurementId: "G-5QXDZJ0T1S"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // å…¨åŸŸè®Šæ•¸
        let currentRole = 'control'; // é è¨­è§’è‰²
        window.currentRole = currentRole; 

        // ç›£è½è³‡æ–™åº«è®Šå‹• (æ ¸å¿ƒåŠŸèƒ½ï¼šå³æ™‚é€£å‹•)
        const bedsRef = ref(db, 'beds');
        onValue(bedsRef, (snapshot) => {
            const data = snapshot.val();
            renderGrid(data || {});
        });

        // æ¸²æŸ“ç•«é¢
        function renderGrid(beds) {
            const grid = document.getElementById('bed-grid');
            grid.innerHTML = '';
            
            const bedList = Object.keys(beds).sort().map(key => ({id: key, ...beds[key]}));

            if (bedList.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">ç›®å‰ç„¡åºŠè™Ÿè³‡æ–™ï¼Œè«‹ç”±æ§åˆ¶ç«¯æ–°å¢ã€‚</div>';
                return;
            }

            bedList.forEach(bed => {
                const div = document.createElement('div');
                div.className = `bed-card h-24 flex flex-col items-center justify-center rounded-lg shadow-sm text-xl font-bold border ${getStatusClass(bed)}`;
                
                // é¡¯ç¤ºåºŠè™Ÿ
                div.innerHTML = `<span>${bed.id}</span>`;
                
                // ç‹€æ…‹æ–‡å­—
                if(bed.readyForBilling) {
                    div.innerHTML += `<span class="text-xs mt-1">å¯è¾¦å‡ºé™¢</span>`;
                } else if (bed.preDischarge) {
                    div.innerHTML += `<span class="text-xs mt-1">é å‡ºé™¢</span>`;
                }

                // é»æ“Šäº‹ä»¶
                div.onclick = () => handleBedClick(bed);
                
                // (æ§åˆ¶ç«¯å°ˆç”¨) é›™æ“Šåˆªé™¤åºŠè™Ÿ
                if (currentRole === 'control' && !bed.preDischarge && !bed.readyForBilling) {
                     div.ondblclick = () => deleteBed(bed.id);
                }

                grid.appendChild(div);
            });
        }

        // å–å¾—ç‹€æ…‹å°æ‡‰çš„ CSS class
        function getStatusClass(bed) {
            if (bed.readyForBilling) return 'status-ready';
            if (bed.preDischarge) return 'status-pre-discharge';
            return 'status-normal';
        }

        // è™•ç†é»æ“Šé‚è¼¯
        window.handleBedClick = function(bed) {
            const updates = {};
            
            if (currentRole === 'control') {
                const newStatus = !bed.preDischarge;
                updates[`/beds/${bed.id}/preDischarge`] = newStatus;
                if (newStatus === false) {
                    updates[`/beds/${bed.id}/readyForBilling`] = false; 
                }
            } 
            else if (currentRole === 'nursing') {
                if (!bed.preDischarge) {
                    alert("æ§åˆ¶ç«¯å°šæœªæ¨™è¨˜æ­¤åºŠä½ç‚ºé å‡ºé™¢ï¼");
                    return;
                }
                updates[`/beds/${bed.id}/readyForBilling`] = !bed.readyForBilling;
            }

            update(ref(db), updates);
        }

        // æ–°å¢åºŠè™Ÿ
        window.addBed = function() {
            const id = document.getElementById('new-bed-id').value.trim();
            if (!id) return;
            set(ref(db, 'beds/' + id), {
                preDischarge: false,
                readyForBilling: false
            });
            document.getElementById('new-bed-id').value = '';
        }

        // åˆªé™¤åºŠè™Ÿ
        window.deleteBed = function(id) {
            if(confirm(`ç¢ºå®šè¦ç§»é™¤åºŠè™Ÿ ${id} å—ï¼Ÿ`)) {
                remove(ref(db, 'beds/' + id));
            }
        }

        // åˆ‡æ›è§’è‰² UI
        window.setRole = function(role) {
            currentRole = role;
            document.getElementById('btn-control').className = role === 'control' ? "px-4 py-2 rounded bg-blue-500 text-white font-bold" : "px-4 py-2 rounded bg-gray-200 text-gray-700";
            document.getElementById('btn-nursing').className = role === 'nursing' ? "px-4 py-2 rounded bg-green-500 text-white font-bold" : "px-4 py-2 rounded bg-gray-200 text-gray-700";
            
            document.getElementById('admin-panel').classList.toggle('hidden', role !== 'control');
            document.getElementById('nursing-panel').classList.toggle('hidden', role !== 'nursing');
        }
        
        // åˆå§‹ UI è¨­å®š
        setRole('control');
    </script>
</body>
</html>
