<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç—…æˆ¿å‡ºé™¢å³æ™‚çœ‹æ¿ (V20-AutoSort)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        /* [ç²¾ç°¡] user-select åªéœ€ä¸€è¡Œï¼Œç¾ä»£ç€è¦½å™¨å·²å…¨é¢æ”¯æ´ */
        body { user-select: none; touch-action: manipulation; }

        .status-normal      { background-color: #ffffff; color: #374151; border: 2px solid #e5e7eb; }
        .status-pre-discharge { background-color: #fff1f2; color: #9d174d; border: 2px solid #be185d; }
        .status-ready       { background-color: #f0fdf4; color: #166534; border: 2px solid #15803d; }
        .status-billed      { background-color: #fff7ed; color: #9a3412; border: 2px solid #ea580c; }
        .status-delayed     { background-color: #eff6ff; color: #1e40af; border: 2px solid #3b82f6; }

        .bed-card {
            transition: transform 0.1s, background-color 0.1s, border-color 0.1s;
            cursor: pointer;
            touch-action: none;
            -webkit-user-drag: none;
            box-sizing: border-box;
            position: relative;
        }
        .bed-card:active { transform: scale(0.96); }

        .separator-card {
            width: 100%; height: 16px; margin: 2px 0;
            display: flex; align-items: center; justify-content: center;
            cursor: grab;
        }

        .sortable-ghost { opacity: 0.2 !important; background: #e5e7eb !important; border: 2px dashed #9ca3af !important; }
        .sortable-drag  { cursor: grabbing; opacity: 1 !important; background: #ffffff; box-shadow: 0 10px 15px -3px rgba(0,0,0,.25); transform: scale(1.05); z-index: 9999 !important; }
        .cursor-locked  { cursor: default !important; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to   { transform: translateX(100%); opacity: 0; } }
        .toast-animate-in  { animation: slideIn 0.3s ease-out forwards; }
        .toast-animate-out { animation: fadeOut 0.3s ease-in  forwards; }
        .toast-card { cursor: pointer; transition: transform 0.1s; }

        .modal-overlay { background-color: rgba(0,0,0,.5); backdrop-filter: blur(2px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* [æ–°å¢] counter å‹•ç•«ç”¨ CSS class å–ä»£ JS inlineï¼Œé¿å… race condition */
        @keyframes popBadge { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        .badge-pop { animation: popBadge 0.2s ease; }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4 min-h-screen">

    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 w-full max-w-sm px-4 sm:px-0"></div>

    <div id="modal-container" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-sm p-4 transform transition-all scale-100">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-3 text-center border-b pb-2">é¸å–®</h3>
            <div id="modal-content" class="space-y-2 max-h-[50vh] overflow-y-auto p-1"></div>
            <div class="mt-4 pt-2 border-t flex justify-center">
                <button id="modal-close-btn" class="w-full py-2 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <div class="mb-2 flex flex-col sm:flex-row justify-between items-center bg-white p-2 rounded-lg shadow-sm gap-2">
            <h1 class="text-base sm:text-lg font-bold text-gray-800 flex items-center gap-2 whitespace-nowrap">
                ğŸ¥ çœ‹æ¿
                <span id="role-badge" class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">æ§åˆ¶ç«¯</span>
            </h1>

            <div class="flex flex-col items-end gap-1 w-full sm:w-auto">
                <div class="flex flex-nowrap overflow-x-auto no-scrollbar items-center gap-2 w-full sm:w-auto justify-end px-1">
                    <div class="flex bg-gray-100 p-1 rounded-lg shrink-0">
                        <button id="btn-control" class="px-3 py-1 rounded text-xs font-bold shadow transition whitespace-nowrap">æ§åˆ¶</button>
                        <button id="btn-nursing" class="px-3 py-1 rounded text-xs font-bold shadow transition whitespace-nowrap">è­·ç†</button>
                        <button id="btn-clerk"   class="px-3 py-1 rounded text-xs font-bold shadow transition whitespace-nowrap">æ›¸è¨˜</button>
                    </div>
                    <button id="btn-notify-toggle" class="shrink-0 px-3 py-1 rounded bg-gray-200 text-gray-500 border border-gray-300 font-bold text-xs hover:bg-gray-300 transition flex items-center gap-1 whitespace-nowrap">
                        ğŸ”• éœéŸ³
                    </button>
                </div>

                <div class="flex flex-nowrap gap-2 text-[10px] sm:text-xs font-bold px-1 overflow-x-auto no-scrollbar w-full sm:w-auto justify-end">
                    <div id="badge-pre"     class="bg-pink-100   text-pink-700   px-2 py-0.5 rounded border border-pink-200   whitespace-nowrap flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-pink-500"></span>  é å‡º: <span id="count-pre">0</span></div>
                    <div id="badge-ready"   class="bg-green-100  text-green-700  px-2 py-0.5 rounded border border-green-200  whitespace-nowrap flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> å¯è¾¦: <span id="count-ready">0</span></div>
                    <div id="badge-billed"  class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded border border-orange-200 whitespace-nowrap flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-orange-500"></span>å·²è¾¦: <span id="count-billed">0</span></div>
                    <div id="badge-delayed" class="bg-blue-50    text-blue-700   px-2 py-0.5 rounded border border-blue-200   whitespace-nowrap flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span>  å»¶é²: <span id="count-delayed">0</span></div>
                </div>
            </div>
        </div>

        <div id="admin-panel" class="mb-2 bg-blue-50 p-2 rounded-lg border border-blue-100 shadow-sm hidden">
            <div class="flex flex-nowrap items-center gap-2 overflow-x-auto no-scrollbar w-full">
                <div class="flex items-center gap-2 shrink-0 border-r border-blue-200 pr-2 mr-1">
                    <span class="text-xl">âš™ï¸</span>
                    <button id="btn-edit-mode" class="bg-gray-500 text-white px-3 py-1.5 rounded-md font-bold shadow text-xs hover:bg-gray-600 transition flex items-center gap-1 whitespace-nowrap">
                        ğŸ”’ é–å®šä¸­
                    </button>
                </div>
                <div id="edit-tools" class="flex items-center gap-2 hidden shrink-0">
                    <input type="text" id="new-bed-id" placeholder="åºŠè™Ÿ"
                           class="border p-1.5 rounded w-16 text-center focus:ring-2 focus:ring-blue-400 outline-none text-xs">
                    <button id="btn-add-bed"  class="bg-blue-600 text-white px-3 py-1.5 rounded font-bold shadow text-xs whitespace-nowrap hover:bg-blue-700">æ–°å¢</button>
                    <button id="btn-add-sep"  class="bg-gray-500 text-white px-3 py-1.5 rounded font-bold shadow text-xs whitespace-nowrap hover:bg-gray-600">â¬‡ï¸ æ›è¡Œ</button>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <button id="btn-reason-config" class="bg-indigo-100 text-indigo-700 border border-indigo-300 px-3 py-1.5 rounded font-bold hover:bg-indigo-200 shadow text-xs whitespace-nowrap">ğŸ“ åŸå› </button>
                    <button id="btn-clear-all"     class="bg-red-100 text-red-600 border border-red-300 px-3 py-1.5 rounded font-bold hover:bg-red-200 shadow text-xs whitespace-nowrap transition">â™»ï¸ é‡ç½®</button>
                </div>
            </div>
        </div>

        <div id="nursing-panel" class="mb-2 bg-green-50 p-2 rounded-lg border border-green-100 shadow-sm hidden">
            <div class="flex items-center gap-2">
                <span class="text-xl">ğŸ‘©â€âš•ï¸</span>
                <div class="text-xs text-gray-700">
                    <span class="font-bold">è­·ç†å€ï¼š</span>é»æ“Š <span class="text-green-600 font-bold">â—</span> å®Œæˆã€‚<span class="text-blue-600 font-bold">é•·æŒ‰/å³éµ</span> æ¨™è¨˜å»¶é²ã€‚
                </div>
            </div>
        </div>

        <div id="clerk-panel" class="mb-2 bg-orange-50 p-2 rounded-lg border border-orange-100 shadow-sm hidden">
            <div class="flex items-center gap-2">
                <span class="text-xl">ğŸ“</span>
                <div class="text-xs text-gray-700">
                    <span class="font-bold">æ›¸è¨˜å€ï¼š</span>å°é å‡ºé™¢(ç²‰ç´…)åºŠè™Ÿ <span class="text-purple-600 font-bold">é•·æŒ‰/å³éµ</span> å¯åŠ è¨»ã€Œå¯è‡³è­·ç†ç«™ã€ã€‚
                </div>
            </div>
        </div>

        <div id="bed-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 content-start min-h-[200px] pb-20">
            <div class="col-span-full text-center text-gray-400 py-10">è³‡æ–™è¼‰å…¥ä¸­...</div>
        </div>
    </div>

<script type="module">
import { initializeApp }  from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// â”€â”€â”€ Firebase åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
    apiKey: "AIzaSyDmuMbCIPPZZlxxpYKiruDEdspUDtSWYjM",
    authDomain: "discharge-86653.firebaseapp.com",
    databaseURL: "https://discharge-86653-default-rtdb.firebaseio.com",
    projectId: "discharge-86653",
    storageBucket: "discharge-86653.firebasestorage.app",
    messagingSenderId: "558090656575",
    appId: "1:558090656575:web:eeadf5009dfc90bf86d18a",
    measurementId: "G-5QXDZJ0T1S"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// â”€â”€â”€ ç‹€æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentRole    = 'control';
let sortableInstance = null;
let localBedList   = [];          // å”¯ä¸€è³‡æ–™ä¾†æºï¼Œé¿å…é‡è¤‡è®€ DB
let isDragging     = false;
let lastBedStates  = {};          // ç”¨æ–¼é€šçŸ¥ diff
let isNotifyEnabled = false;
let isFlashing     = false;
let flashInterval  = null;
let isEditMode     = false;
let reasonList     = [];
const originalTitle = document.title;

const defaultReasons = ["ç­‰å¾…å®¶å±¬", "ç­‰å¾…æª¢æŸ¥å ±å‘Š", "å¸³å‹™å•é¡Œ", "ç—…æƒ…è®ŠåŒ–", "ç­‰å¾…æ•‘è­·è»Š", "å…¶ä»–"];

// â”€â”€â”€ è³‡æ–™å¿«ç…§åºåˆ—åŒ–ï¼ˆç”¨æ–¼ dirty-checkï¼Œé¿å…ä¸å¿…è¦é‡ç¹ªï¼‰â”€â”€â”€â”€â”€â”€â”€â”€
// [å„ªåŒ–] ç”¨è¼•é‡å­—ä¸²æ¯”å°ï¼Œåªæœ‰è³‡æ–™çœŸæ­£æ”¹è®Šæ‰é‡ç¹ª DOM
let lastRenderKey = '';
function buildRenderKey(list) {
    return list.map(b =>
        `${b.id}:${b.type||''}:${b.preDischarge?1:0}:${b.readyForBilling?1:0}:${b.billed?1:0}:${b.delayed?1:0}:${b.delayReason||''}:${b.showClerkNote?1:0}:${b.index}`
    ).join('|');
}

// â”€â”€â”€ Firebase ç›£è½ï¼šbeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [å„ªåŒ–] onValue åªåœ¨è³‡æ–™çœŸæ­£æ”¹è®Šæ™‚æ‰é‡ç¹ªï¼Œæ¸›å°‘ä¸å¿…è¦ DOM æ“ä½œ
const bedsRef = ref(db, 'beds');
onValue(bedsRef, (snapshot) => {
    if (isDragging) return;  // æ‹–æ›³ä¸­ç•¥éï¼Œç­‰æ”¾é–‹å¾Œ saveNewOrder() æœƒè§¸ç™¼

    const data = snapshot.val() || {};

    const newList = Object.keys(data).map(key => ({
        id: key,
        ...data[key],
        preDischarge:    !!data[key].preDischarge,
        readyForBilling: !!data[key].readyForBilling,
        billed:          !!data[key].billed,
        delayed:         !!data[key].delayed,
        delayReason:     data[key].delayReason  || '',
        showClerkNote:   !!data[key].showClerkNote,
        index:           data[key].index !== undefined ? Number(data[key].index) : 9999
    })).sort((a, b) => {
        // [ä¿®æ”¹é‡é»] å¿½ç•¥æ‰‹å‹• indexï¼Œå¼·åˆ¶ä¾ç…§åºŠè™Ÿ ID æ’åº
        // numeric: true å¯ç¢ºä¿ "10" æ’åœ¨ "2" å¾Œé¢ (è‡ªç„¶æ’åº)
        return a.id.localeCompare(b.id, undefined, { numeric: true });
    });

    // [å„ªåŒ–] dirty-checkï¼škey ç›¸åŒè¡¨ç¤ºè³‡æ–™æœªè®Šï¼Œä¸é‡ç¹ª
    const newKey = buildRenderKey(newList);
    const dataChanged = newKey !== lastRenderKey;
    lastRenderKey = newKey;

    localBedList = newList;
    updateCounts(localBedList);
    checkAndNotify(localBedList);
    if (dataChanged) renderGrid();
});

// â”€â”€â”€ Firebase ç›£è½ï¼šreasons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [å„ªåŒ–] reasons åªåœ¨é¦–æ¬¡æˆ–çœŸæ­£è®Šæ›´æ™‚æ‰åˆå§‹åŒ–ï¼Œä¸è§¸ç™¼é‡ç¹ª
const reasonsRef = ref(db, 'reasons');
onValue(reasonsRef, (snapshot) => {
    const val = snapshot.val();
    if (val) {
        reasonList = val;
    } else {
        reasonList = defaultReasons;
        set(reasonsRef, defaultReasons);   // åªå¯«å…¥ä¸€æ¬¡ï¼Œå¾ŒçºŒä¸å†è§¸ç™¼
    }
});

// â”€â”€â”€ è¨ˆæ•¸å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [ä¿®æ­£] ç”¨ CSS animation class å–ä»£ classList add/setTimeout removeï¼Œé¿å… race condition
function updateCounts(beds) {
    let pre = 0, ready = 0, billed = 0, delayed = 0;
    beds.forEach(bed => {
        if (bed.type === 'separator') return;
        if      (bed.billed)          billed++;
        else if (bed.delayed)         delayed++;
        else if (bed.readyForBilling) ready++;
        else if (bed.preDischarge)    pre++;
    });
    setCount('count-pre',     'badge-pre',     pre);
    setCount('count-ready',   'badge-ready',   ready);
    setCount('count-billed',  'badge-billed',  billed);
    setCount('count-delayed', 'badge-delayed', delayed);
}

function setCount(spanId, badgeId, value) {
    const span  = document.getElementById(spanId);
    const badge = document.getElementById(badgeId);
    if (span.innerText == value) return;
    span.innerText = value;
    // ç§»é™¤å¾Œé‡æ–°åŠ å…¥ä»¥é‡æ’­ animation
    badge.classList.remove('badge-pop');
    void badge.offsetWidth;   // force reflow
    badge.classList.add('badge-pop');
}

// â”€â”€â”€ é€šçŸ¥ç³»çµ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkAndNotify(beds) {
    const isFirst = Object.keys(lastBedStates).length === 0;
    let hasNew = false;
    beds.forEach(bed => {
        if (bed.type === 'separator') return;
        if (!isFirst && isNotifyEnabled && bed.readyForBilling && lastBedStates[bed.id] !== true) {
            showToast(bed.id);
            hasNew = true;
        }
        lastBedStates[bed.id] = bed.readyForBilling;
    });
    if (hasNew && document.hidden) startTitleFlash();
}

function startTitleFlash() {
    if (isFlashing) return;
    isFlashing = true;
    let alt = true;
    flashInterval = setInterval(() => {
        document.title = alt ? 'ğŸ””ã€æœ‰æ–°é€šçŸ¥ã€‘' : originalTitle;
        alt = !alt;
    }, 1000);
}

function stopTitleFlash() {
    clearInterval(flashInterval);
    document.title = originalTitle;
    isFlashing = false;
}

function showToast(bedId) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast-card toast-animate-in bg-green-600 text-white px-4 py-3 rounded-lg shadow-xl flex items-center justify-between gap-3 border border-green-400 w-full';
    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="text-xl">ğŸ””</span>
            <div>
                <div class="text-xs font-light opacity-90">è­·ç†ç«™é€šçŸ¥</div>
                <div class="text-lg font-bold">${bedId} å¯è¾¦å‡ºé™¢</div>
            </div>
        </div>
        <div class="text-green-200 text-lg font-bold px-2">âœ•</div>`;
    toast.addEventListener('click', () => {
        toast.classList.replace('toast-animate-in', 'toast-animate-out');
        setTimeout(() => toast.remove(), 300);
    });
    container.appendChild(toast);
}

// â”€â”€â”€ æ¸²æŸ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGrid() {
    const grid = document.getElementById('bed-grid');
    grid.innerHTML = '';

    if (localBedList.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">ç›®å‰ç„¡è³‡æ–™ï¼Œè«‹ç”±æ§åˆ¶ç«¯æ–°å¢ã€‚</div>';
        initSortable();
        return;
    }

    const frag = document.createDocumentFragment();  // [å„ªåŒ–] ç”¨ fragment ä¸€æ¬¡æ’å…¥ï¼Œæ¸›å°‘ reflow

    localBedList.forEach(bed => {
        const div = document.createElement('div');
        div.setAttribute('data-id', bed.id);

        if (bed.type === 'separator') {
            div.className = 'separator-card col-span-full';
            if (currentRole === 'control' && isEditMode) {
                div.innerHTML = '<div class="w-full border-b-2 border-dashed border-gray-300 text-center text-xs text-gray-400 leading-[0.1em] pointer-events-none"><span class="bg-gray-100 px-2">æ›è¡Œ (é›™æ“Šåˆªé™¤)</span></div>';
                div.addEventListener('dblclick', (e) => { e.stopPropagation(); deleteBed(bed.id); });
            } else {
                div.innerHTML = '<div class="w-full h-2"></div>';
                div.classList.add('cursor-default');
            }
        } else {
            const isActive = bed.preDischarge || bed.readyForBilling || bed.billed || bed.delayed;
            div.className = `bed-card flex flex-col items-center justify-center rounded-xl shadow-sm min-h-[5rem] sm:min-h-[6rem] ${getStatusClass(bed)}${isActive ? ' shadow-md transform scale-[1.02]' : ''}`;

            let inner = `<span class="text-xl sm:text-2xl font-bold pointer-events-none">${bed.id}</span>`;
            if (bed.billed) {
                inner += `<span class="text-[10px] sm:text-xs font-bold bg-orange-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">å·²è¾¦å‡ºé™¢</span>`;
            } else if (bed.delayed) {
                const label = bed.delayReason || 'å»¶é²';
                inner += `<span class="text-[10px] sm:text-xs font-bold bg-blue-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none truncate max-w-[90%]">${label}</span>`;
            } else if (bed.readyForBilling) {
                inner += `<span class="text-[10px] sm:text-xs font-bold bg-green-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">å¯è¾¦å‡ºé™¢</span>`;
            } else if (bed.preDischarge) {
                inner += `<span class="text-[10px] sm:text-xs font-bold bg-pink-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">é å‡ºé™¢</span>`;
                if (bed.showClerkNote) {
                    inner += `<span class="text-[10px] sm:text-xs font-bold bg-purple-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none animate-pulse">å¯è‡³è­·ç†ç«™</span>`;
                }
            }
            div.innerHTML = inner;

            attachBedEvents(div, bed);

            if (currentRole === 'control' && isEditMode && !isActive) {
                div.addEventListener('dblclick', (e) => { e.stopPropagation(); deleteBed(bed.id); });
                div.title = 'é›™æ“Šåˆªé™¤';
            }
        }
        frag.appendChild(div);
    });

    grid.appendChild(frag);
    initSortable();
}

// â”€â”€â”€ åºŠå¡äº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [ä¿®æ­£] é•·æŒ‰å¾Œ touchend é˜»æ­¢ click é‡è¤‡è§¸ç™¼ï¼ˆè¡Œå‹•è£ç½® bugï¼‰
function attachBedEvents(element, bed) {
    let pressTimer  = null;
    let isLongPress = false;

    // --- æ»‘é¼  ---
    element.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        isLongPress = false;
        pressTimer = setTimeout(() => {
            isLongPress = true;
            handleLongPress(bed);
        }, 800);
    });
    element.addEventListener('mouseup', () => clearTimeout(pressTimer));
    element.addEventListener('mouseleave', () => clearTimeout(pressTimer));

    // --- è§¸æ§ ---
    element.addEventListener('touchstart', (e) => {
        isLongPress = false;
        pressTimer = setTimeout(() => {
            isLongPress = true;
            handleLongPress(bed);
        }, 800);
    }, { passive: true });

    // [ä¿®æ­£] é•·æŒ‰å¾Œé˜»æ­¢ click è§¸ç™¼ï¼ˆåŸæœ¬æ²’æœ‰ preventDefaultï¼‰
    element.addEventListener('touchend', (e) => {
        clearTimeout(pressTimer);
        if (isLongPress) e.preventDefault();   // â† é—œéµä¿®æ­£
    });

    // å³éµé¸å–®
    element.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if (currentRole === 'nursing') {
            openReasonModal(bed);
        } else if (currentRole === 'clerk' && bed.preDischarge && !bed.readyForBilling && !bed.billed) {
            toggleClerkNote(bed);
        }
    });

    // çŸ­æŒ‰ click
    element.addEventListener('click', () => {
        if (!isLongPress) handleShortClick(bed);
    });
}

// â”€â”€â”€ çŸ­æŒ‰é‚è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [ä¿®æ­£] clerk é‚è¼¯æ•´ç†ï¼›å»¶é²è§£é™¤æ”¹ç”¨ modalï¼ˆå–ä»£åŸç”Ÿ confirmï¼‰
// [å„ªåŒ–] æ‰€æœ‰ç‹€æ…‹è®Šæ›´çµ±ä¸€ç”¨å–®ä¸€ update() æ‰¹æ¬¡å¯«å…¥ï¼Œæ¸›å°‘ Firebase å‘¼å«æ¬¡æ•¸
function handleShortClick(bed) {
    if (isDragging) return;

    // å»¶é²ç‹€æ…‹ï¼šé»æ“Š â†’ modal ç¢ºèªè§£é™¤
    if (bed.delayed) {
        if (currentRole === 'nursing' || currentRole === 'control') {
            openConfirmModal(`è§£é™¤ã€Œ${bed.id}ã€çš„å»¶é²ç‹€æ…‹ï¼Ÿ`, () => {
                dbUpdate({ [`/beds/${bed.id}/delayed`]: false, [`/beds/${bed.id}/delayReason`]: '' });
            });
        }
        return;
    }

    const path = `/beds/${bed.id}`;

    if (currentRole === 'control') {
        // æ§åˆ¶ç«¯ï¼šåˆ‡æ›é å‡ºé™¢
        dbUpdate({ [`${path}/preDischarge`]: !bed.preDischarge });
    }
    else if (currentRole === 'nursing') {
        // è­·ç†ç«¯ï¼šåˆ‡æ›å¯è¾¦å‡ºé™¢
        // [ä¿®æ­£] åŒæ­¥æ¸…é™¤ showClerkNoteï¼Œé¿å…å‚™è¨»æ®˜ç•™
        const updates = {
            [`${path}/readyForBilling`]: !bed.readyForBilling,
        };
        if (!bed.readyForBilling) {
            // å¾ã€Œæœªæº–å‚™ã€â†’ã€Œå¯è¾¦ã€ï¼šæ¸…é™¤æ›¸è¨˜å‚™è¨»ï¼Œç¢ºä¿ç‹€æ…‹ä¹¾æ·¨
            updates[`${path}/showClerkNote`] = false;
        } else {
            // å¾ã€Œå¯è¾¦ã€â†’ã€Œå–æ¶ˆã€ï¼šåŒæ­¥æ¸…é™¤ billed é¿å…ç‹€æ…‹çŸ›ç›¾
            updates[`${path}/billed`] = false;
        }
        dbUpdate(updates);
    }
    else if (currentRole === 'clerk') {
        // [ä¿®æ­£] æ›¸è¨˜ç«¯é‚è¼¯æ•´ç†ï¼š
        //   - readyForBilling æˆ– billed æ‰å…è¨±åˆ‡æ› billed
        //   - preDischarge æ™‚çŸ­æŒ‰ç„¡å‹•ä½œï¼ˆé•·æŒ‰æ‰åŠ å‚™è¨»ï¼‰
        //   - å…¶ä»–ç‹€æ…‹æç¤º
        if (bed.readyForBilling || bed.billed) {
            dbUpdate({ [`${path}/billed`]: !bed.billed });
        }
        // preDischargeï¼šçŸ­æŒ‰éœé»˜ï¼Œå¼•å°é•·æŒ‰ä½¿ç”¨ï¼ˆé¢æ¿èªªæ˜å·²æœ‰æŒ‡ç¤ºï¼‰
        // å…¶ä»–ï¼ˆnormalï¼‰ï¼šä¸å‹•ä½œ
    }
}

// â”€â”€â”€ é•·æŒ‰é‚è¼¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleLongPress(bed) {
    if (navigator.vibrate) navigator.vibrate(50);
    if (currentRole === 'nursing') {
        openReasonModal(bed);
    } else if (currentRole === 'clerk') {
        if (bed.preDischarge && !bed.readyForBilling && !bed.billed) {
            toggleClerkNote(bed);
        }
    }
}

// â”€â”€â”€ æ›¸è¨˜å‚™è¨» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleClerkNote(bed) {
    dbUpdate({ [`/beds/${bed.id}/showClerkNote`]: !bed.showClerkNote });
}

// â”€â”€â”€ DB å¯«å…¥å°è£ï¼ˆé›†ä¸­ç®¡ç†ï¼Œæ–¹ä¾¿å¾ŒçºŒ debug/throttleï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [å„ªåŒ–] æ‰€æœ‰å¯«å…¥éƒ½é€šéæ­¤å‡½å¼ï¼Œæœªä¾†å¯åŠ  throttle/debounce é˜²æŠ–
function dbUpdate(updates) {
    update(ref(db), updates);
}

// â”€â”€â”€ å»¶é²åŸå›  Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openReasonModal(bed) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').innerText = `${bed.id} å»¶é²åŸå› `;
    content.innerHTML = '';
    reasonList.forEach(reason => {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 text-blue-800 font-bold mb-2 active:bg-blue-200 transition';
        btn.innerText = reason;
        btn.addEventListener('click', () => {
            dbUpdate({ [`/beds/${bed.id}/delayed`]: true, [`/beds/${bed.id}/delayReason`]: reason });
            closeModal();
        });
        content.appendChild(btn);
    });
    showModal();
}

// â”€â”€â”€ ç¢ºèª Modalï¼ˆå–ä»£åŸç”Ÿ confirmï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [ä¿®æ­£] çµ±ä¸€ç”¨è‡ªè¨‚ modalï¼Œç§»é™¤æ‰€æœ‰åŸç”Ÿ confirm()/alert()
function openConfirmModal(message, onConfirm) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').innerText = 'ç¢ºèªæ“ä½œ';
    content.innerHTML = `
        <p class="text-center text-gray-700 py-4 font-medium">${message}</p>
        <div class="flex gap-2">
            <button id="modal-confirm-ok"     class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">ç¢ºå®š</button>
            <button id="modal-confirm-cancel" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
        </div>`;
    document.getElementById('modal-confirm-ok').addEventListener('click', () => { onConfirm(); closeModal(); });
    document.getElementById('modal-confirm-cancel').addEventListener('click', closeModal);
    showModal();
}

// â”€â”€â”€ åŸå› è¨­å®š Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openReasonConfig() {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').innerText = 'ç·¨è¼¯åŸå› ';
    content.innerHTML = `
        <div class="mb-4 flex gap-2">
            <input id="new-reason-input" class="border p-2 rounded flex-grow text-sm" placeholder="æ–°åŸå› ">
            <button id="btn-add-reason" class="bg-green-500 text-white px-3 py-2 rounded font-bold text-sm">æ–°å¢</button>
        </div>`;
    const listDiv = document.createElement('div');
    listDiv.className = 'space-y-2';
    reasonList.forEach((reason, index) => {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border';
        row.innerHTML = `<span class="font-bold text-gray-700 text-sm">${reason}</span>`;
        const delBtn = document.createElement('button');
        delBtn.className = 'text-red-500 font-bold px-2 py-1 bg-red-50 rounded hover:bg-red-100 text-sm';
        delBtn.innerText = 'åˆªé™¤';
        delBtn.addEventListener('click', () => removeReason(index));
        row.appendChild(delBtn);
        listDiv.appendChild(row);
    });
    content.appendChild(listDiv);

    document.getElementById('btn-add-reason').addEventListener('click', () => {
        const input = document.getElementById('new-reason-input');
        const val = input.value.trim();
        if (val) {
            set(ref(db, 'reasons'), [...reasonList, val]);
            // [å„ªåŒ–] ä¸é‡æ–°æ‰“é–‹ modalï¼Œç›´æ¥åœ¨åŸåœ°æ–°å¢ä¸€è¡Œ
            const row = document.createElement('div');
            row.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border';
            const newIndex = reasonList.length; // åœ¨ onValue æ›´æ–°å‰çš„æš«æ™‚ index
            row.innerHTML = `<span class="font-bold text-gray-700 text-sm">${val}</span>`;
            const delBtn2 = document.createElement('button');
            delBtn2.className = 'text-red-500 font-bold px-2 py-1 bg-red-50 rounded hover:bg-red-100 text-sm';
            delBtn2.innerText = 'åˆªé™¤';
            delBtn2.addEventListener('click', () => removeReason(newIndex));
            row.appendChild(delBtn2);
            listDiv.appendChild(row);
            input.value = '';
        }
    });
    showModal();
}

function removeReason(index) {
    openConfirmModal('ç¢ºå®šåˆªé™¤æ­¤åŸå› ï¼Ÿ', () => {
        set(ref(db, 'reasons'), reasonList.filter((_, i) => i !== index));
    });
}

function showModal() {
    const m = document.getElementById('modal-container');
    m.classList.remove('hidden');
    m.classList.add('flex');
}

function closeModal() {
    const m = document.getElementById('modal-container');
    m.classList.add('hidden');
    m.classList.remove('flex');
}

// â”€â”€â”€ Sortable æ‹–æ›³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSortable() {
    const grid = document.getElementById('bed-grid');
    if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }

    if (currentRole === 'control' && isEditMode) {
        sortableInstance = new Sortable(grid, {
            animation: 150, forceFallback: true, fallbackOnBody: true,
            fallbackClass: 'sortable-drag', ghostClass: 'sortable-ghost',
            delay: 50, delayOnTouchOnly: true,
            onStart: () => { isDragging = true; },
            onEnd:   () => { isDragging = false; saveNewOrder(); }
        });
        grid.classList.remove('cursor-locked');
    } else {
        grid.classList.add('cursor-locked');
    }
}

// [å„ªåŒ–] saveNewOrder ç›´æ¥è®€ DOMï¼Œä¸åšé¡å¤– DB get()
function saveNewOrder() {
    const updates = {};
    document.querySelectorAll('#bed-grid [data-id]').forEach((el, i) => {
        updates[`/beds/${el.getAttribute('data-id')}/index`] = i;
    });
    dbUpdate(updates);
}

function getStatusClass(bed) {
    if (bed.billed)          return 'status-billed';
    if (bed.delayed)         return 'status-delayed';
    if (bed.readyForBilling) return 'status-ready';
    if (bed.preDischarge)    return 'status-pre-discharge';
    return 'status-normal';
}

// â”€â”€â”€ åºŠä½ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addBed() {
    const input = document.getElementById('new-bed-id');
    const id = input.value.trim();
    if (!id) return;
    // [å„ªåŒ–] ç”¨ localBedList å– maxIndexï¼Œä¸éœ€é¡å¤– DB get()
    const maxIndex = localBedList.length > 0 ? Math.max(...localBedList.map(b => Number(b.index) || 0)) : 0;
    set(ref(db, `beds/${id}`), {
        type: 'bed', preDischarge: false, readyForBilling: false,
        billed: false, delayed: false, delayReason: '', showClerkNote: false,
        index: maxIndex + 1
    });
    input.value = '';
    input.focus();
}

function addSeparator() {
    const maxIndex = localBedList.length > 0 ? Math.max(...localBedList.map(b => Number(b.index) || 0)) : 0;
    set(ref(db, `beds/SEP_${Date.now()}`), { type: 'separator', index: maxIndex + 1 });
}

function deleteBed(id) {
    const msg = id.startsWith('SEP_') ? 'ç§»é™¤æ­¤æ›è¡Œåˆ†éš”ç·šï¼Ÿ' : `åˆªé™¤åºŠè™Ÿ ${id}ï¼Ÿ`;
    openConfirmModal(msg, () => remove(ref(db, `beds/${id}`)));
}

function clearAllStatuses() {
    openConfirmModal('ç¢ºå®šè¦æ¸…é™¤ã€Œæ‰€æœ‰ã€ç‹€æ…‹é¡è‰²ï¼Ÿ', () => {
        const updates = {};
        localBedList.forEach(bed => {
            if (bed.type === 'separator') return;
            // [å„ªåŒ–] åªå¯«æœ‰ç‹€æ…‹çš„æ¬„ä½ï¼Œä¸å¯« falseâ†’false çš„ç„¡æ„ç¾©æ›´æ–°
            if (bed.preDischarge)    updates[`/beds/${bed.id}/preDischarge`]    = false;
            if (bed.readyForBilling) updates[`/beds/${bed.id}/readyForBilling`] = false;
            if (bed.billed)          updates[`/beds/${bed.id}/billed`]          = false;
            if (bed.delayed)         updates[`/beds/${bed.id}/delayed`]         = false;
            if (bed.delayReason)     updates[`/beds/${bed.id}/delayReason`]     = '';
            if (bed.showClerkNote)   updates[`/beds/${bed.id}/showClerkNote`]   = false;
        });
        if (Object.keys(updates).length) dbUpdate(updates);
    });
}

// â”€â”€â”€ è§’è‰²åˆ‡æ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setRole(role) {
    currentRole = role;
    const roleMap = {
        control: { label: 'æ§åˆ¶ç«¯', color: 'blue',   badgeClass: 'bg-blue-100   text-blue-800'   },
        nursing: { label: 'è­·ç†ç«¯', color: 'green',  badgeClass: 'bg-green-100  text-green-800'  },
        clerk:   { label: 'æ›¸è¨˜ç«¯', color: 'orange', badgeClass: 'bg-orange-100 text-orange-800' },
    };

    ['control', 'nursing', 'clerk'].forEach(r => {
        const btn = document.getElementById(`btn-${r}`);
        if (r === role) {
            const { color } = roleMap[r];
            btn.className = `px-3 py-1 rounded text-white font-bold shadow transition text-xs whitespace-nowrap bg-${color}-500`;
        } else {
            btn.className = 'px-3 py-1 rounded bg-white text-gray-500 shadow transition hover:bg-gray-100 text-xs whitespace-nowrap';
        }
    });

    const badge = document.getElementById('role-badge');
    badge.innerText  = roleMap[role].label;
    badge.className  = `text-xs px-2 py-1 rounded ${roleMap[role].badgeClass}`;

    document.getElementById('admin-panel').classList.toggle('hidden',   role !== 'control');
    document.getElementById('nursing-panel').classList.toggle('hidden', role !== 'nursing');
    document.getElementById('clerk-panel').classList.toggle('hidden',   role !== 'clerk');

    renderGrid();
}

function toggleEditMode() {
    isEditMode = !isEditMode;
    const btn = document.getElementById('btn-edit-mode');
    const tools = document.getElementById('edit-tools');
    if (isEditMode) {
        btn.innerHTML  = 'ğŸ”“ ç·¨è¼¯ä¸­';
        btn.className  = 'bg-yellow-500 text-white px-3 py-1.5 rounded-md font-bold shadow text-xs hover:bg-yellow-600 transition flex items-center gap-1 whitespace-nowrap';
        tools.classList.remove('hidden');
    } else {
        btn.innerHTML  = 'ğŸ”’ é–å®šä¸­';
        btn.className  = 'bg-gray-500 text-white px-3 py-1.5 rounded-md font-bold shadow text-xs hover:bg-gray-600 transition flex items-center gap-1 whitespace-nowrap';
        tools.classList.add('hidden');
    }
    renderGrid();
}

function toggleNotify() {
    isNotifyEnabled = !isNotifyEnabled;
    const btn = document.getElementById('btn-notify-toggle');
    if (isNotifyEnabled) {
        btn.innerHTML  = 'ğŸ”” é€šçŸ¥ï¼šé–‹å•Ÿ';
        btn.className  = 'shrink-0 px-3 py-1 rounded bg-green-100 text-green-700 border border-green-300 font-bold text-xs hover:bg-green-200 transition flex items-center gap-1 whitespace-nowrap';
    } else {
        btn.innerHTML  = 'ğŸ”• éœéŸ³';
        btn.className  = 'shrink-0 px-3 py-1 rounded bg-gray-200 text-gray-500 border border-gray-300 font-bold text-xs hover:bg-gray-300 transition flex items-center gap-1 whitespace-nowrap';
        stopTitleFlash();
    }
}

// â”€â”€â”€ äº‹ä»¶ç¶å®šï¼ˆå–ä»£ onclick="..." HTML å±¬æ€§ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [ä¿®æ­£] å…¨éƒ¨æ”¹ç”¨ addEventListenerï¼Œç§»é™¤å…¨åŸŸ window æš´éœ²
document.addEventListener('DOMContentLoaded', () => {
    // è§’è‰²åˆ‡æ›
    document.getElementById('btn-control').addEventListener('click', () => setRole('control'));
    document.getElementById('btn-nursing').addEventListener('click', () => setRole('nursing'));
    document.getElementById('btn-clerk').addEventListener('click',   () => setRole('clerk'));

    // é€šçŸ¥åˆ‡æ›
    document.getElementById('btn-notify-toggle').addEventListener('click', toggleNotify);

    // æ§åˆ¶ç«¯å·¥å…·
    document.getElementById('btn-edit-mode').addEventListener('click', toggleEditMode);
    document.getElementById('btn-add-bed').addEventListener('click',   addBed);
    document.getElementById('btn-add-sep').addEventListener('click',   addSeparator);
    document.getElementById('btn-reason-config').addEventListener('click', openReasonConfig);
    document.getElementById('btn-clear-all').addEventListener('click', clearAllStatuses);
    document.getElementById('modal-close-btn').addEventListener('click', closeModal);

    // Enter æ–°å¢åºŠè™Ÿ
    document.getElementById('new-bed-id').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addBed();
    });

    // é é¢æ¢å¾©å¯è¦‹æ™‚åœæ­¢ title é–ƒçˆ
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) stopTitleFlash();
    });

    // åˆå§‹åŒ–è§’è‰²
    const params = new URLSearchParams(window.location.search);
    const v = params.get('v');
    if      (v === '2') setRole('nursing');
    else if (v === '3') setRole('clerk');
    else                setRole('control');
});
</script>
</body>
</html>
