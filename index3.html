<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç—…æˆ¿å‡ºé™¢å³æ™‚çœ‹æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        * { font-family: 'Noto Sans TC', sans-serif; }
        body { user-select: none; touch-action: manipulation; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€åºŠä½ç‹€æ…‹è‰²ã€‘
           è¦æ”¹é¡è‰²å°±æ”¹é€™è£¡å°æ‡‰çš„ background / color / border
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .status-normal        { background: #fff;    color: #374151; border: 2px solid #e5e7eb; }
        .status-pre-discharge { background: #fff1f2; color: #9d174d; border: 2px solid #be185d; }
        .status-ready         { background: #f0fdf4; color: #166534; border: 2px solid #15803d; }
        .status-billed        { background: #fff7ed; color: #9a3412; border: 2px solid #ea580c; }
        .status-delayed       { background: #eff6ff; color: #1e40af; border: 2px solid #3b82f6; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€åºŠå¡æœ¬é«”æ¨£å¼ã€‘
           position: relative æ˜¯å¿…é ˆçš„ï¼Œè®“ç•™è¨€å¾½ç« å®šä½åœ¨å¡ç‰‡å³ä¸Šè§’
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .bed-card {
            transition: transform 0.12s ease, box-shadow 0.12s ease;
            cursor: pointer;
            touch-action: none;
            box-sizing: border-box;
            position: relative; /* â† ä¸å¯åˆªï¼Œç•™è¨€å¾½ç« éœ€è¦é€™å€‹æ‰èƒ½å®šä½åœ¨å³ä¸Šè§’ */
        }
        .bed-card:active { transform: scale(0.94); }

        /* ç·¨è¼¯æ¨¡å¼ä¸‹åºŠå¡å¤–è§€ï¼ˆè™›ç·šæ¡†ï¼‰ */
        .bed-card.edit-mode-card { border-style: dashed !important; opacity: 0.82; }
        .bed-card.edit-mode-card:hover { opacity: 1; transform: scale(1.04); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€æ‹–æ‹‰æ›çµ„æ•ˆæœã€‘
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .bed-card.draggable { cursor: grab; }
        .bed-card.draggable:active { cursor: grabbing; }
        .sortable-ghost {
            opacity: 0.15 !important;
            background: #c7d2fe !important;
            border: 2px dashed #6366f1 !important;
            border-radius: 0.75rem;
        }
        .sortable-drag-class {
            opacity: 1 !important;
            box-shadow: 0 16px 40px -8px rgba(79,70,229,.45) !important;
            transform: scale(1.08) rotate(1.5deg) !important;
            z-index: 9999 !important;
            cursor: grabbing !important;
        }
        /* æ‹–å…¥æ™‚ç›®æ¨™åˆ†çµ„å®¹å™¨çš„é«˜äº®å¤–æ¡† */
        .group-drop-active {
            background: #eef2ff !important;
            box-shadow: 0 0 0 2px #6366f1 inset;
            border-radius: 0 0 0.75rem 0.75rem;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€åˆ†çµ„å€å¡Šå‹•ç•« & æ¨™é¡Œæ¨£å¼ã€‘
           group-header çš„ border-left é¡è‰²å¯è‡ªè¡Œæ›´æ›
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .group-section { animation: fadeInUp 0.2s ease both; }
        @keyframes fadeInUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
        .group-header {
            background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
            border-left: 4px solid #818cf8; /* â† å·¦å´ç´«è‰²æ¢ï¼Œå¯æ”¹è‰² */
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€Toast é€šçŸ¥å‹•ç•«ã€‘
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes slideIn { from { transform:translateX(110%); opacity:0; } to { transform:translateX(0); opacity:1; } }
        @keyframes fadeOut { to   { transform:translateX(110%); opacity:0; } }
        .toast-in  { animation: slideIn .3s ease-out forwards; }
        .toast-out { animation: fadeOut .3s ease-in  forwards; }

        /* Modal é®ç½© */
        .modal-overlay { background: rgba(0,0,0,.52); backdrop-filter: blur(3px); }

        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€é ‚éƒ¨è¨ˆæ•¸å¾½ç« å½ˆè·³å‹•ç•«ã€‘
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes popBadge { 0%,100% { transform:scale(1); } 50% { transform:scale(1.18); } }
        .badge-pop { animation: popBadge .25s ease; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€åˆ†çµ„ç¯©é¸ Tab æ¨£å¼ã€‘
           .active æ˜¯é¸ä¸­ç‹€æ…‹çš„æ¨£å¼
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .group-tab { transition: all .15s ease; }
        .group-tab.active {
            background: #4f46e5 !important;
            color: #fff !important;
            border-color: #4338ca !important;
            box-shadow: 0 2px 8px rgba(79,70,229,.35);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€ç•™è¨€å¾½ç« ï¼ˆåºŠå¡å³ä¸Šè§’æ•¸å­—ï¼‰ã€‘
           ç´…è‰² = æœ‰æœªè®€ç•™è¨€ï¼ˆè·³å‹•ï¼‰
           ç¶ è‰²ï¼ˆ.msg-badge-readï¼‰= å…¨éƒ¨å·²è®€çš„èˆŠç•™è¨€ï¼ˆéœæ…‹ï¼‰
           top / right æ§åˆ¶å¾½ç« è·å¡ç‰‡é‚Šç·£çš„è·é›¢
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes bounceBadge {
            0%,100% { transform: translateY(0) scale(1); }
            30%     { transform: translateY(-4px) scale(1.15); }
            60%     { transform: translateY(-2px) scale(1.05); }
        }
        .msg-badge {
            position: absolute;
            top: -8px; right: -8px; /* â† èª¿æ•´å¾½ç« ä½ç½® */
            min-width: 20px; height: 20px; padding: 0 4px;
            background: #ef4444; /* â† æœªè®€ç´…è‰² */
            color: #fff;
            font-size: 10px; font-weight: 900;
            border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(239,68,68,.5);
            animation: bounceBadge 1.2s ease infinite; /* â† æœªè®€æ™‚è·³å‹• */
            cursor: pointer; z-index: 10;
        }
        .msg-badge:hover { background: #dc2626; transform: scale(1.2); animation: none; }

        /* å·²è®€èˆŠç•™è¨€ â†’ ç¶ è‰²ã€ä¸è·³å‹• */
        .msg-badge.msg-badge-read {
            background: #16a34a; /* â† å·²è®€ç¶ è‰² */
            box-shadow: 0 2px 6px rgba(22,163,74,.4);
            animation: none;
        }
        .msg-badge.msg-badge-read:hover { background: #15803d; transform: scale(1.2); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€ç•™è¨€åˆ—è¡¨æ¨£å¼ã€‘
           æœªè®€ï¼ˆ.msg-unreadï¼‰æ–‡å­—åŠ ç²—ï¼Œå·²è®€ï¼ˆ.msg-readï¼‰æ–‡å­—æ·ºç°
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .msg-item { transition: background .15s; }
        .msg-item:hover { background: #f8fafc; }
        .msg-unread .msg-text { font-weight: 900; color: #1e293b; }
        .msg-read   .msg-text { font-weight: 400; color: #64748b; }
        /* ç•™è¨€å‚™è¨»æ¨™ç±¤ï¼ˆé»ƒè‰²åº•ï¼‰ */
        .msg-note-label {
            font-size: 10px; background: #fef9c3; color: #854d0e;
            border: 1px solid #fde68a; border-radius: 4px;
            padding: 1px 5px; display: inline-block; margin-top: 2px;
        }
    </style>
</head>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ã€body èƒŒæ™¯è‰²ã€‘bg-slate-100 å¯æ›é é¢èƒŒæ™¯
     p-2 sm:p-4 æ˜¯é é¢é‚Šè·
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<body class="bg-slate-100 p-2 sm:p-4 min-h-screen">

<!-- Toast é€šçŸ¥å®¹å™¨ï¼ˆå³ä¸‹è§’æµ®å‹•ï¼‰ -->
<div id="toast-container"
     class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 w-full max-w-sm px-3 sm:px-0 pointer-events-none">
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Modal é€šç”¨å½ˆçª—
     max-w-md æ§åˆ¶å½ˆçª—æœ€å¤§å¯¬åº¦
     max-h-[65vh] æ§åˆ¶å…§å®¹å€æœ€å¤§é«˜åº¦
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="modal-container" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay">
    <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-md p-5 transform transition-all">
        <h3 id="modal-title" class="text-base font-black text-gray-800 mb-3 text-center border-b pb-2 tracking-wide">é¸å–®</h3>
        <div id="modal-content" class="space-y-1.5 max-h-[65vh] overflow-y-auto pr-1"></div>
        <div class="mt-4 pt-3 border-t">
            <button id="modal-close-btn"
                    class="w-full py-2.5 bg-gray-100 text-gray-500 rounded-xl font-bold hover:bg-gray-200 transition text-sm">
                é—œé–‰
            </button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ã€æ•´é«”ç‰ˆé¢å¯¬åº¦ã€‘
     w-[90%] = ä½”è¢å¹•å¯¬åº¦ 90%ï¼Œmx-auto æ°´å¹³ç½®ä¸­
     âœ è¦æ”¹æ•´é«”å¯¬åº¦ï¼Œå°±æ”¹ w-[90%] é€™å€‹å€¼
        ä¾‹å¦‚ w-[95%]ï¼ˆæ›´å¯¬ï¼‰ã€w-fullï¼ˆå…¨å¯¬ï¼‰ã€max-w-7xlï¼ˆå›ºå®šæœ€å¤§å¯¬ï¼‰
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="w-[90%] mx-auto space-y-2">

    <!-- Header æ¨™é¡Œåˆ— -->
    <div class="flex flex-col sm:flex-row justify-between items-center bg-white p-2.5 rounded-xl shadow-sm gap-2">
        <h1 class="text-base sm:text-lg font-black text-gray-800 flex items-center gap-2 whitespace-nowrap tracking-tight">
            ğŸ¥ å‡ºé™¢çœ‹æ¿
            <span id="role-badge" class="text-xs px-2.5 py-1 rounded-lg bg-blue-100 text-blue-800 font-bold">æ§åˆ¶ç«¯</span>
        </h1>
        <div class="flex flex-col items-end gap-1.5 w-full sm:w-auto">
            <!-- è§’è‰²åˆ‡æ› + é€šçŸ¥æŒ‰éˆ• -->
            <div class="flex flex-nowrap overflow-x-auto no-scrollbar items-center gap-2 w-full sm:w-auto justify-end">
                <div class="flex bg-gray-100 p-1 rounded-xl shrink-0 gap-0.5">
                    <button id="btn-control" class="px-3 py-1.5 rounded-lg text-xs font-bold transition whitespace-nowrap">æ§åˆ¶</button>
                    <button id="btn-nursing" class="px-3 py-1.5 rounded-lg text-xs font-bold transition whitespace-nowrap">è­·ç†</button>
                    <button id="btn-clerk"   class="px-3 py-1.5 rounded-lg text-xs font-bold transition whitespace-nowrap">æ›¸è¨˜</button>
                </div>
                <button id="btn-notify-toggle"
                        class="shrink-0 px-3 py-1.5 rounded-xl bg-gray-200 text-gray-500 border border-gray-300 font-bold text-xs hover:bg-gray-300 transition whitespace-nowrap">
                    ğŸ”• éœéŸ³
                </button>
            </div>
            <!-- é ‚éƒ¨å››è‰²è¨ˆæ•¸å¾½ç«  -->
            <div class="flex flex-nowrap gap-1.5 text-[10px] sm:text-xs font-bold overflow-x-auto no-scrollbar w-full sm:w-auto justify-end">
                <div id="badge-pre"     class="bg-pink-100   text-pink-700   px-2 py-0.5 rounded-lg border border-pink-200   flex items-center gap-1 whitespace-nowrap"><span class="w-2 h-2 rounded-full bg-pink-500  shrink-0"></span>é å‡º: <span id="count-pre">0</span></div>
                <div id="badge-ready"   class="bg-green-100  text-green-700  px-2 py-0.5 rounded-lg border border-green-200  flex items-center gap-1 whitespace-nowrap"><span class="w-2 h-2 rounded-full bg-green-500 shrink-0"></span>å¯è¾¦: <span id="count-ready">0</span></div>
                <div id="badge-billed"  class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-lg border border-orange-200 flex items-center gap-1 whitespace-nowrap"><span class="w-2 h-2 rounded-full bg-orange-500 shrink-0"></span>å·²è¾¦: <span id="count-billed">0</span></div>
                <div id="badge-delayed" class="bg-blue-50    text-blue-700   px-2 py-0.5 rounded-lg border border-blue-200   flex items-center gap-1 whitespace-nowrap"><span class="w-2 h-2 rounded-full bg-blue-500  shrink-0"></span>å»¶é²: <span id="count-delayed">0</span></div>
            </div>
        </div>
    </div>

    <!-- æ§åˆ¶ç«¯å·¥å…·é¢æ¿ -->
    <div id="admin-panel" class="bg-indigo-50 p-2.5 rounded-xl border border-indigo-100 shadow-sm hidden">
        <div class="flex flex-nowrap items-center gap-2 overflow-x-auto no-scrollbar w-full">
            <span class="text-xl shrink-0">âš™ï¸</span>
            <button id="btn-edit-mode"
                    class="shrink-0 bg-gray-500 text-white px-3 py-1.5 rounded-lg font-bold shadow text-xs hover:bg-gray-600 transition whitespace-nowrap">
                ğŸ”’ é–å®šä¸­
            </button>
            <!-- ç·¨è¼¯å·¥å…·åˆ—ï¼ˆé–å®šæ™‚éš±è—ï¼‰ -->
            <div id="edit-tools" class="hidden">
                <div class="flex items-center gap-2 flex-nowrap">
                    <input type="text" id="new-bed-id" placeholder="åºŠè™Ÿ"
                           class="border p-1.5 rounded-lg w-16 text-center focus:ring-2 focus:ring-indigo-400 outline-none text-xs font-bold">
                    <select id="new-bed-group"
                            class="border p-1.5 rounded-lg text-xs focus:ring-2 focus:ring-indigo-400 outline-none font-bold max-w-[100px]">
                    </select>
                    <button id="btn-add-bed"
                            class="shrink-0 bg-indigo-600 text-white px-3 py-1.5 rounded-lg font-bold shadow text-xs hover:bg-indigo-700 whitespace-nowrap">
                        ï¼‹ æ–°å¢åºŠè™Ÿ
                    </button>
                    <button id="btn-group-config"
                            class="shrink-0 bg-purple-100 text-purple-700 border border-purple-300 px-3 py-1.5 rounded-lg font-bold hover:bg-purple-200 shadow text-xs whitespace-nowrap">
                        ğŸ·ï¸ ç®¡ç†åˆ†çµ„
                    </button>
                </div>
            </div>
            <button id="btn-reason-config"
                    class="shrink-0 bg-sky-100 text-sky-700 border border-sky-300 px-3 py-1.5 rounded-lg font-bold hover:bg-sky-200 shadow text-xs whitespace-nowrap">
                ğŸ“ åŸå› 
            </button>
            <button id="btn-clear-all"
                    class="shrink-0 bg-red-100 text-red-600 border border-red-300 px-3 py-1.5 rounded-lg font-bold hover:bg-red-200 shadow text-xs whitespace-nowrap">
                â™»ï¸ é‡ç½®
            </button>
        </div>
    </div>

    <!-- è­·ç†ç«¯æç¤ºé¢æ¿ -->
    <div id="nursing-panel" class="bg-green-50 p-2.5 rounded-xl border border-green-100 shadow-sm hidden">
        <div class="flex items-center gap-2 text-xs text-gray-600">
            <span class="text-xl">ğŸ‘©â€âš•ï¸</span>
            <span><b class="text-gray-800">è­·ç†ï¼š</b>é»æ“ŠåºŠè™Ÿå®Œæˆæº–å‚™ï¼›<b class="text-blue-600">é•·æŒ‰ / å³éµ</b>æ¨™è¨˜å»¶é²åŸå› ã€‚</span>
        </div>
    </div>

    <!-- æ›¸è¨˜ç«¯æç¤ºé¢æ¿ -->
    <div id="clerk-panel" class="bg-orange-50 p-2.5 rounded-xl border border-orange-100 shadow-sm hidden">
        <div class="flex items-center gap-2 text-xs text-gray-600">
            <span class="text-xl">ğŸ“</span>
            <span><b class="text-gray-800">æ›¸è¨˜ï¼š</b>å°ç²‰ç´…è‰²åºŠè™Ÿ<b class="text-purple-600">é•·æŒ‰ / å³éµ</b>å¯åŠ è¨»ã€Œå¯è‡³è­·ç†ç«™ã€ã€‚</span>
        </div>
    </div>

    <!-- åˆ†çµ„ç¯©é¸ Tab åˆ—ï¼ˆæœ‰å…©å€‹ä»¥ä¸Šåˆ†çµ„æ‰é¡¯ç¤ºï¼‰ -->
    <div id="group-filter-bar" class="flex flex-nowrap gap-1.5 overflow-x-auto no-scrollbar pb-0.5 hidden"></div>

    <!-- åºŠä½ä¸»å€ï¼ˆå„åˆ†çµ„å¡ç‰‡åœ¨é€™è£¡æ¸²æŸ“ï¼‰ -->
    <div id="bed-grid" class="min-h-[200px] pb-20 space-y-3">
        <div class="text-center text-gray-400 py-12 text-sm">è³‡æ–™è¼‰å…¥ä¸­â‹¯</div>
    </div>

</div><!-- /w-[90%] -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, update, push }
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Firebase è¨­å®š
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const firebaseConfig = {
    apiKey:            "AIzaSyDmuMbCIPPZZlxxpYKiruDEdspUDtSWYjM",
    authDomain:        "discharge-86653.firebaseapp.com",
    databaseURL:       "https://discharge-86653-default-rtdb.firebaseio.com",
    projectId:         "discharge-86653",
    storageBucket:     "discharge-86653.firebasestorage.app",
    messagingSenderId: "558090656575",
    appId:             "1:558090656575:web:eeadf5009dfc90bf86d18a"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å…¨åŸŸç‹€æ…‹è®Šæ•¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentRole         = 'control';  // ç›®å‰è§’è‰²ï¼šcontrol / nursing / clerk
let localBedList        = [];         // åºŠä½è³‡æ–™å¿«å–
let groups              = {};         // åˆ†çµ„è³‡æ–™å¿«å– { groupId: { name, index } }
let selectedGroupFilter = 'all';      // ç›®å‰é¸ä¸­çš„åˆ†çµ„ Tab
let lastBedStates       = {};         // åµæ¸¬ã€Œå¯è¾¦å‡ºé™¢ã€ç‹€æ…‹è®ŠåŒ–ç”¨
let isNotifyEnabled     = false;      // é€šçŸ¥é–‹é—œ
let isFlashing          = false;      // æ¨™é¡Œåˆ—é–ƒçˆä¸­
let flashInterval       = null;
let isEditMode          = false;      // æ§åˆ¶ç«¯ç·¨è¼¯æ¨¡å¼
let reasonList          = [];         // å»¶é²åŸå› åˆ—è¡¨
let groupsLoaded        = false;      // Firebase è³‡æ–™è¼‰å…¥æ——æ¨™
let bedsLoaded          = false;
let localMessages       = {};         // ç•™è¨€å¿«å– { bedId: { msgId: { text,time,readByNursing,readByClerk,note } } }
let msgSortDesc         = true;       // ç•™è¨€æ’åºï¼štrue=æ–°â†’èˆŠ
const originalTitle     = document.title;
const DEFAULT_REASONS   = ["ç­‰å¾…å®¶å±¬","ç­‰å¾…æª¢æŸ¥å ±å‘Š","å¸³å‹™å•é¡Œ","ç—…æƒ…è®ŠåŒ–","ç­‰å¾…æ•‘è­·è»Š","å…¶ä»–"];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DB å¯«å…¥å°è£ï¼ˆæ‰€æœ‰ Firebase å¯«å…¥éƒ½èµ°é€™è£¡ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const dbUpdate = (updates) => update(ref(db), updates);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ç•™è¨€è¼”åŠ©å‡½å¼
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// å–å¾—æŸåºŠçš„æœªè®€ç•™è¨€æ•¸ï¼ˆä¾è§’è‰²åˆ¤æ–·ï¼‰
function getUnreadCount(bedId, role) {
    const msgs = localMessages[bedId];
    if (!msgs) return 0;
    return Object.values(msgs).filter(m =>
        role === 'nursing' ? !m.readByNursing : !m.readByClerk
    ).length;
}

// å–å¾—æŸåºŠçš„ç¸½ç•™è¨€æ•¸ï¼ˆæ§åˆ¶ç«¯ç”¨ï¼‰
function getTotalMsgCount(bedId) {
    const msgs = localMessages[bedId];
    return msgs ? Object.keys(msgs).length : 0;
}

// æ›´æ–°æ‰€æœ‰åºŠå¡çš„ç•™è¨€å¾½ç« ï¼ˆä¸é‡ç¹ªæ•´å€‹ gridï¼‰
function refreshAllBadges() {
    document.querySelectorAll('#bed-grid [data-id]').forEach(el => {
        const bedId    = el.dataset.id;
        const existing = el.querySelector('.msg-badge');
        const total    = getTotalMsgCount(bedId);
        const unread   = (currentRole === 'control') ? total : getUnreadCount(bedId, currentRole);
        const isRead   = total > 0 && unread === 0;  // æœ‰ç•™è¨€ä½†å…¨å·²è®€

        if (total === 0) {
            existing?.remove();
        } else if (unread > 0) {
            // ç´…è‰²è·³å‹•ï¼šæœ‰æœªè®€
            if (existing) { existing.textContent = unread; existing.classList.remove('msg-badge-read'); }
            else          { el.appendChild(createMsgBadge(bedId, unread, false)); }
        } else {
            // ç¶ è‰²éœæ…‹ï¼šæœ‰èˆŠç•™è¨€ä½†å…¨å·²è®€
            if (existing) { existing.textContent = total; existing.classList.add('msg-badge-read'); }
            else          { el.appendChild(createMsgBadge(bedId, total, true)); }
        }
    });
}

// å»ºç«‹ç•™è¨€å¾½ç« å…ƒç´ 
// isRead=false â†’ ç´…è‰²è·³å‹•ï¼›isRead=true â†’ ç¶ è‰²éœæ…‹
function createMsgBadge(bedId, count, isRead = false) {
    const badge = document.createElement('div');
    badge.className = `msg-badge${isRead ? ' msg-badge-read' : ''}`;
    badge.textContent = count;
    badge.dataset.badge = 'true';
    badge.addEventListener('click', (e) => {
        e.stopPropagation(); // é˜²æ­¢è§¸ç™¼åºŠå¡çš„ click äº‹ä»¶
        openMessageListModal(bedId);
    });
    return badge;
}

// åµæ¸¬æ–°ç•™è¨€ä¸¦å½ˆå‡º Toast
function checkNewMsgNotify(newData) {
    if (!isNotifyEnabled) return;
    Object.keys(newData).forEach(bedId => {
        const newCount = Object.keys(newData[bedId] || {}).length;
        const oldCount = Object.keys(localMessages[bedId] || {}).length;
        if (newCount > oldCount) {
            const latest = Object.values(newData[bedId]).sort((a,b) => b.time - a.time)[0];
            showMsgToast(bedId, latest?.text || '');
        }
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Firebase å³æ™‚ç›£è½
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// ç›£è½åˆ†çµ„è³‡æ–™
onValue(ref(db, 'groups'), (snap) => {
    const val = snap.val();
    if (!val) {
        groups = { default: { name: 'æœªåˆ†çµ„', index: 0 } };
        set(ref(db, 'groups'), groups);
    } else {
        groups = val;
        if (!groups.default) {
            groups.default = { name: 'æœªåˆ†çµ„', index: -1 };
            set(ref(db, 'groups/default'), groups.default);
        }
    }
    groupsLoaded = true;
    updateGroupSelectOptions();
    if (bedsLoaded) renderGrid();
});

// ç›£è½åºŠä½è³‡æ–™
onValue(ref(db, 'beds'), (snap) => {
    const data = snap.val() || {};
    localBedList = Object.keys(data)
        .filter(key => !data[key].type || data[key].type === 'bed')
        .map(key => ({
            id:              key,
            ...data[key],
            groupId:         data[key].groupId        || 'default',
            preDischarge:    !!data[key].preDischarge,
            readyForBilling: !!data[key].readyForBilling,
            billed:          !!data[key].billed,
            delayed:         !!data[key].delayed,
            delayReason:     data[key].delayReason    || '',
            showClerkNote:   !!data[key].showClerkNote,
        }));
    bedsLoaded = true;
    updateCounts(localBedList);
    checkAndNotify(localBedList);
    if (groupsLoaded) renderGrid();
});

// ç›£è½å»¶é²åŸå› åˆ—è¡¨
onValue(ref(db, 'reasons'), (snap) => {
    const val = snap.val();
    reasonList = val || DEFAULT_REASONS;
    if (!val) set(ref(db, 'reasons'), DEFAULT_REASONS);
});

// ç›£è½ç•™è¨€è³‡æ–™
onValue(ref(db, 'messages'), (snap) => {
    const data = snap.val() || {};
    checkNewMsgNotify(data);

    // â˜… ä¿ç•™æœ¬åœ°å·²æ¨™è¨˜ç‚º true çš„å·²è®€æ——æ¨™
    // Firebase onValue æœ‰æ™‚æœƒå…ˆå›å‚³èˆŠå¿«ç…§ï¼ŒæŠŠå‰›å¯«å…¥çš„ true è“‹å› false
    // ç”¨åˆä½µæ–¹å¼ç¢ºä¿å·²è®€ç‹€æ…‹ä¸å€’é€€
    Object.keys(data).forEach(bedId => {
        Object.keys(data[bedId] || {}).forEach(msgId => {
            const local = localMessages?.[bedId]?.[msgId];
            if (local?.readByNursing) data[bedId][msgId].readByNursing = true;
            if (local?.readByClerk)   data[bedId][msgId].readByClerk   = true;
        });
    });

    localMessages = data;
    refreshAllBadges();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æ’åºè¼”åŠ©
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// å–å¾—ä¾ index æ’åºçš„åˆ†çµ„é™£åˆ—
function getSortedGroups() {
    return Object.entries(groups)
        .map(([id, g]) => ({ id, ...g, index: g.index ?? 0 }))
        .sort((a, b) => a.index - b.index);
}

// å–å¾—æŸåˆ†çµ„å…§çš„åºŠä½ï¼Œä¾åºŠè™Ÿè‡ªç„¶æ’åºï¼ˆ2 < 10 < 22ï¼‰
function getBedsForGroup(groupId) {
    return localBedList
        .filter(b => (b.groupId || 'default') === groupId)
        .sort((a, b) => a.id.localeCompare(b.id, undefined, { numeric: true }));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   é ‚éƒ¨è¨ˆæ•¸å¾½ç« 
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateCounts(beds) {
    let pre = 0, ready = 0, billed = 0, delayed = 0;
    beds.forEach(b => {
        if      (b.billed)          billed++;
        else if (b.delayed)         delayed++;
        else if (b.readyForBilling) ready++;
        else if (b.preDischarge)    pre++;
    });
    setCount('count-pre',     'badge-pre',     pre);
    setCount('count-ready',   'badge-ready',   ready);
    setCount('count-billed',  'badge-billed',  billed);
    setCount('count-delayed', 'badge-delayed', delayed);
}

function setCount(spanId, badgeId, val) {
    const span  = document.getElementById(spanId);
    const badge = document.getElementById(badgeId);
    if (span.textContent == val) return;
    span.textContent = val;
    badge.classList.remove('badge-pop');
    void badge.offsetWidth; // å¼·åˆ¶ reflow ä»¥é‡æ’­å‹•ç•«
    badge.classList.add('badge-pop');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å‡ºé™¢é€šçŸ¥ï¼ˆç‹€æ…‹æ”¹è®Š â†’ Toast / æ¨™é¡Œé–ƒçˆï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function checkAndNotify(beds) {
    const isFirst = Object.keys(lastBedStates).length === 0;
    let hasNew = false;
    beds.forEach(bed => {
        if (!isFirst && isNotifyEnabled && bed.readyForBilling && !lastBedStates[bed.id]) {
            showToast(bed.id);
            hasNew = true;
        }
        lastBedStates[bed.id] = bed.readyForBilling;
    });
    if (hasNew && document.hidden) startTitleFlash();
}

function startTitleFlash() {
    if (isFlashing) return;
    isFlashing = true;
    let alt = true;
    flashInterval = setInterval(() => {
        document.title = alt ? 'ğŸ””ã€æœ‰æ–°é€šçŸ¥ã€‘' : originalTitle;
        alt = !alt;
    }, 1000);
}

function stopTitleFlash() {
    clearInterval(flashInterval);
    document.title = originalTitle;
    isFlashing = false;
}

// å‡ºé™¢é€šçŸ¥ Toastï¼ˆç¶ è‰²ï¼‰
function showToast(bedId) {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = 'toast-in bg-green-600 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center justify-between gap-3 border border-green-400 w-full pointer-events-auto cursor-pointer';
    t.innerHTML = `<div class="flex items-center gap-3"><span class="text-xl">ğŸ””</span><div><div class="text-xs opacity-80">è­·ç†ç«™é€šçŸ¥</div><div class="text-base font-black">${bedId} å¯è¾¦å‡ºé™¢</div></div></div><div class="text-2xl opacity-60 font-bold">âœ•</div>`;
    t.addEventListener('click', () => { t.classList.replace('toast-in','toast-out'); setTimeout(()=>t.remove(),300); });
    c.appendChild(t);
    setTimeout(() => { if (!t.classList.contains('toast-out')) { t.classList.replace('toast-in','toast-out'); setTimeout(()=>t.remove(),300); } }, 8000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ä¸»æ¸²æŸ“å‡½å¼ renderGrid()
   æ¯æ¬¡è³‡æ–™æ›´æ–°æˆ–è§’è‰²åˆ‡æ›éƒ½æœƒé‡æ–°å‘¼å«
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGrid() {
    const container = document.getElementById('bed-grid');
    container.innerHTML = '';

    const sortedGroups = getSortedGroups();
    if (localBedList.length === 0 && !isEditMode) {
        container.innerHTML = '<div class="text-center text-gray-400 py-12 text-sm">ç›®å‰ç„¡åºŠè™Ÿï¼Œè«‹ç”±æ§åˆ¶ç«¯ â†’ ç·¨è¼¯æ¨¡å¼æ–°å¢ã€‚</div>';
        updateGroupFilterBar(sortedGroups);
        return;
    }

    const frag = document.createDocumentFragment();

    sortedGroups.forEach(group => {
        if (selectedGroupFilter !== 'all' && selectedGroupFilter !== group.id) return;
        const beds = getBedsForGroup(group.id);
        if (beds.length === 0 && !isEditMode && selectedGroupFilter === 'all') return;

        // åˆ†çµ„å€å¡Š
        const section = document.createElement('div');
        section.className = 'group-section';
        section.dataset.groupId = group.id;

        // åˆ†çµ„æ¨™é¡Œåˆ—
        const header = document.createElement('div');
        header.className = 'group-header flex items-center justify-between px-3 py-2 rounded-t-xl border border-gray-200';
        const left = document.createElement('div');
        left.className = 'flex items-center gap-2';
        left.innerHTML = `<span class="font-black text-gray-700 text-sm tracking-tight">ğŸ·ï¸ ${group.name}</span>
                          <span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded-md">${beds.length} åºŠ</span>`;
        header.appendChild(left);

        // ç·¨è¼¯æ¨¡å¼ä¸‹é¡¯ç¤ºæ”¹å/åˆªé™¤æŒ‰éˆ•
        if (currentRole === 'control' && isEditMode) {
            const right = document.createElement('div');
            right.className = 'flex gap-1';
            const renameBtn = document.createElement('button');
            renameBtn.className = 'text-xs px-2 py-1 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 font-bold';
            renameBtn.textContent = 'âœï¸ æ”¹å';
            renameBtn.addEventListener('click', (e) => { e.stopPropagation(); openRenameGroupModal(group.id, group.name); });
            right.appendChild(renameBtn);
            if (group.id !== 'default') {
                const delBtn = document.createElement('button');
                delBtn.className = 'text-xs px-2 py-1 bg-red-100 text-red-500 rounded-lg hover:bg-red-200 font-bold';
                delBtn.textContent = 'ğŸ—‘ï¸ åˆªçµ„';
                delBtn.addEventListener('click', (e) => { e.stopPropagation(); confirmDeleteGroup(group); });
                right.appendChild(delBtn);
            }
            header.appendChild(right);
        }
        section.appendChild(header);

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ã€åºŠå¡å®¹å™¨ã€‘
           flex flex-wrap â†’ å¡ç‰‡è‡ªå‹•æ›è¡Œ
           gap-2          â†’ å¡ç‰‡é–“è·ï¼ˆå¯æ”¹ gap-3ã€gap-4ï¼‰
           p-2            â†’ å®¹å™¨å…§é‚Šè·
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        const grid = document.createElement('div');
        grid.className = 'flex flex-wrap gap-2 bg-white rounded-b-xl border border-t-0 border-gray-200 p-2 min-h-[76px]';
        grid.dataset.groupId = group.id; // Sortable æ›çµ„ç”¨

        if (beds.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'w-full text-center text-gray-300 text-xs py-4 italic';
            empty.textContent = 'ï¼ˆæ­¤åˆ†çµ„å°šç„¡åºŠè™Ÿï¼‰';
            grid.appendChild(empty);
        } else {
            beds.forEach(bed => grid.appendChild(createBedCard(bed)));
        }

        section.appendChild(grid);
        frag.appendChild(section);
    });

    container.appendChild(frag);
    updateGroupFilterBar(sortedGroups);
    if (currentRole === 'control' && isEditMode) initSortables();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Sortable è·¨åˆ†çµ„æ‹–æ‹‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _sortableInstances = [];

function initSortables() {
    _sortableInstances.forEach(s => s.destroy());
    _sortableInstances = [];
    document.querySelectorAll('#bed-grid [data-group-id]').forEach(gridEl => {
        const inst = new Sortable(gridEl, {
            group:            { name: 'beds', pull: true, put: true },
            animation:        200,
            forceFallback:    true,
            fallbackOnBody:   true,
            ghostClass:       'sortable-ghost',
            dragClass:        'sortable-drag-class',
            delay:            80,
            delayOnTouchOnly: true,
            onEnter: (evt) => evt.to.classList.add('group-drop-active'),
            onLeave: (evt) => evt.from.classList.remove('group-drop-active'),
            onEnd: (evt) => {
                evt.to.classList.remove('group-drop-active');
                evt.from.classList.remove('group-drop-active');
                const bedId      = evt.item.dataset.id;
                const newGroupId = evt.to.dataset.groupId;
                const oldGroupId = evt.from.dataset.groupId;
                if (!bedId || newGroupId === oldGroupId) return;
                dbUpdate({ [`/beds/${bedId}/groupId`]: newGroupId });
            }
        });
        _sortableInstances.push(inst);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å»ºç«‹åºŠå¡ DOM å…ƒç´ 
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function createBedCard(bed) {
    const div = document.createElement('div');
    div.dataset.id = bed.id;

    const isActive  = bed.preDischarge || bed.readyForBilling || bed.billed || bed.delayed;
    const editClass = (currentRole === 'control' && isEditMode) ? ' edit-mode-card' : '';

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ã€åºŠå¡å¯¬åº¦ & æœ€å°é«˜åº¦ã€‘
       w-[10%]    â†’ å›ºå®šä½”å®¹å™¨å¯¬åº¦ 10%ï¼ˆæ¯è¡Œç´„ 9 å¼µï¼‰
       min-w-[60px] â†’ æœ€å°å¯¬åº¦ï¼Œé˜²æ­¢æ‰‹æ©Ÿéçª„
       min-h-[5rem] â†’ å¡ç‰‡æœ€å°é«˜åº¦

       âœ è¦æ”¹å¡ç‰‡å¯¬åº¦å°±æ”¹ w-[10%]ï¼š
            w-[8%]  â†’ æ›´çª„ï¼Œæ¯è¡Œç´„ 11 å¼µ
            w-[12%] â†’ è¼ƒå¯¬ï¼Œæ¯è¡Œç´„ 7 å¼µ
            w-[15%] â†’ å¯¬ï¼Œæ¯è¡Œç´„ 6 å¼µ
       âœ è¦æ”¹å¡ç‰‡é«˜åº¦å°±æ”¹ min-h-[5rem]
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    div.className = `bed-card w-[10%] min-w-[60px] min-h-[5rem] flex flex-col items-center justify-center rounded-xl shadow-sm
        ${getStatusClass(bed)}${isActive ? ' shadow-md' : ''}${editClass}`;

    if (currentRole === 'control' && isEditMode) {
        // ç·¨è¼¯æ¨¡å¼ï¼šé¡¯ç¤ºæ‹–æ‹‰æç¤ºï¼Œé»æ“Šé–‹å•ŸåºŠä½ç®¡ç†
        div.classList.add('draggable');
        div.innerHTML = `
            <span class="text-xl sm:text-2xl font-black pointer-events-none">${bed.id}</span>
            <span class="text-[9px] text-indigo-300 mt-0.5 pointer-events-none">â ¿ æ‹–æ‹‰æ›çµ„</span>`;
        div.addEventListener('click', () => openBedEditModal(bed));
    } else {
        // ä¸€èˆ¬æ¨¡å¼ï¼šé¡¯ç¤ºç‹€æ…‹æ¨™ç±¤
        let inner = `<span class="text-xl sm:text-2xl font-black pointer-events-none">${bed.id}</span>`;
        if (bed.billed) {
            inner += `<span class="text-[10px] font-bold bg-orange-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">å·²è¾¦å‡ºé™¢</span>`;
        } else if (bed.delayed) {
            inner += `<span class="text-[10px] font-bold bg-blue-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none truncate max-w-[90%]">${bed.delayReason || 'å»¶é²'}</span>`;
        } else if (bed.readyForBilling) {
            inner += `<span class="text-[10px] font-bold bg-green-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">å¯è¾¦å‡ºé™¢</span>`;
        } else if (bed.preDischarge) {
            inner += `<span class="text-[10px] font-bold bg-pink-600 text-white px-2 py-0.5 rounded-full mt-1 pointer-events-none">é å‡ºé™¢</span>`;
            if (bed.showClerkNote) {
                inner += `<span class="text-[10px] font-bold bg-purple-600 text-white px-2 py-0.5 rounded-full mt-0.5 pointer-events-none animate-pulse">å¯è‡³è­·ç†ç«™</span>`;
            }
        }
        div.innerHTML = inner;

        // åŠ ä¸Šç•™è¨€å¾½ç« 
        const total  = getTotalMsgCount(bed.id);
        const unread = (currentRole === 'control') ? total : getUnreadCount(bed.id, currentRole);
        if (total > 0) {
            const isRead = unread === 0;
            div.appendChild(createMsgBadge(bed.id, isRead ? total : unread, isRead));
        }

        attachBedEvents(div, bed);
    }
    return div;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   åºŠå¡äº‹ä»¶ç¶å®šï¼ˆé•·æŒ‰ / å³éµ / é»æ“Šï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function attachBedEvents(el, bed) {
    let timer = null, isLP = false;

    el.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        isLP = false;
        timer = setTimeout(() => { isLP = true; handleLongPress(bed); }, 750);
    });
    el.addEventListener('mouseup',    () => clearTimeout(timer));
    el.addEventListener('mouseleave', () => clearTimeout(timer));
    el.addEventListener('touchstart', () => {
        isLP = false;
        timer = setTimeout(() => { isLP = true; handleLongPress(bed); }, 750);
    }, { passive: true });
    el.addEventListener('touchend', (e) => { clearTimeout(timer); if (isLP) e.preventDefault(); });
    el.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if      (currentRole === 'control') openNewMessageModal(bed.id);
        else if (currentRole === 'nursing') openReasonModal(bed);
        else if (currentRole === 'clerk' && bed.preDischarge && !bed.readyForBilling && !bed.billed) toggleClerkNote(bed);
    });
    el.addEventListener('click', () => { if (!isLP) handleShortClick(bed); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   çŸ­æŒ‰é‚è¼¯ï¼ˆå„è§’è‰²é»æ“ŠåºŠå¡çš„è¡Œç‚ºï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleShortClick(bed) {
    if (bed.delayed) {
        if (currentRole === 'nursing' || currentRole === 'control') {
            openConfirmModal(`è§£é™¤ã€Œ${bed.id}ã€çš„å»¶é²ç‹€æ…‹ï¼Ÿ`, () => {
                dbUpdate({ [`/beds/${bed.id}/delayed`]: false, [`/beds/${bed.id}/delayReason`]: '' });
            });
        }
        return;
    }
    const path = `/beds/${bed.id}`;
    if (currentRole === 'control') {
        dbUpdate({ [`${path}/preDischarge`]: !bed.preDischarge });
    } else if (currentRole === 'nursing') {
        const updates = { [`${path}/readyForBilling`]: !bed.readyForBilling };
        if (!bed.readyForBilling) updates[`${path}/showClerkNote`] = false;
        else                      updates[`${path}/billed`]        = false;
        dbUpdate(updates);
    } else if (currentRole === 'clerk') {
        if (bed.readyForBilling || bed.billed) {
            dbUpdate({ [`${path}/billed`]: !bed.billed });
        }
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   é•·æŒ‰é‚è¼¯
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleLongPress(bed) {
    if (navigator.vibrate) navigator.vibrate(50);
    if      (currentRole === 'control') openNewMessageModal(bed.id);
    else if (currentRole === 'nursing') openReasonModal(bed);
    else if (currentRole === 'clerk' && bed.preDischarge && !bed.readyForBilling && !bed.billed) toggleClerkNote(bed);
}

function toggleClerkNote(bed) {
    dbUpdate({ [`/beds/${bed.id}/showClerkNote`]: !bed.showClerkNote });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šæ–°å¢ç•™è¨€
   æ§åˆ¶ç«¯ï¼šå³éµ / é•·æŒ‰åºŠå¡
   è­·ç†ç«¯ï¼šå¾ç•™è¨€åˆ—è¡¨åº•éƒ¨ã€Œï¼‹ æ–°å¢ç•™è¨€ã€é€²å…¥
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openNewMessageModal(bedId) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = `ğŸ’¬ ${bedId} â€” æ–°å¢ç•™è¨€`;
    content.innerHTML = `
        <textarea id="msg-input"
            class="w-full border rounded-xl p-3 text-sm resize-none focus:ring-2 focus:ring-indigo-400 outline-none"
            rows="4" placeholder="è¼¸å…¥ç•™è¨€å…§å®¹â‹¯"></textarea>
        <div class="flex gap-2 mt-2">
            <button id="msg-submit" class="flex-1 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition text-sm">ğŸ“¨ é€å‡º</button>
            <button id="msg-view"   class="px-3 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition text-sm whitespace-nowrap">ğŸ“‹ æŸ¥çœ‹</button>
        </div>`;
    showModal();
    const inp = document.getElementById('msg-input');
    setTimeout(() => inp.focus(), 80);
    const submit = () => {
        const text = inp.value.trim();
        if (!text) return;
        push(ref(db, `messages/${bedId}`), { text, time: Date.now(), readByNursing: false, readByClerk: false, note: '' });
        closeModal();
    };
    document.getElementById('msg-submit').addEventListener('click', submit);
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submit(); } });
    document.getElementById('msg-view').addEventListener('click', () => { closeModal(); openMessageListModal(bedId); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šç•™è¨€åˆ—è¡¨ï¼ˆæ‰€æœ‰è§’è‰²éƒ½å¯æŸ¥çœ‹ï¼‰
   è­·ç† / æ›¸è¨˜é–‹å•Ÿæ™‚è‡ªå‹•æ¨™è¨˜å·²è®€ï¼Œç«‹å³æ›´æ–°æœ¬åœ°å¿«å–é¿å…å¾½ç« é–ƒå›ç´…è‰²
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openMessageListModal(bedId) {
    const msgs = localMessages[bedId] || {};
    const keys = Object.keys(msgs);

    if ((currentRole === 'nursing' || currentRole === 'clerk') && keys.length > 0) {
        const readField = currentRole === 'nursing' ? 'readByNursing' : 'readByClerk';
        const updates = {};
        keys.forEach(k => {
            if (!msgs[k][readField]) {
                updates[`/messages/${bedId}/${k}/${readField}`] = true;
                // â˜… ç«‹å³æ›´æ–°æœ¬åœ°å¿«å–ï¼Œä¸ç­‰ Firebase onValue å›å‚³
                if (!localMessages[bedId]) localMessages[bedId] = {};
                if (!localMessages[bedId][k]) localMessages[bedId][k] = {};
                localMessages[bedId][k][readField] = true;
            }
        });
        if (Object.keys(updates).length) {
            dbUpdate(updates);
            refreshAllBadges(); // ç«‹åˆ»åˆ‡æ›å¾½ç« é¡è‰²
        }
    }
    renderMessageListModal(bedId);
}

function renderMessageListModal(bedId) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = `ğŸ“‹ ${bedId} ç•™è¨€æ¿`;
    content.innerHTML = '';

    const msgs   = localMessages[bedId] || {};
    const sorted = Object.entries(msgs).sort(([,a],[,b]) =>
        msgSortDesc ? b.time - a.time : a.time - b.time
    );

    // å·¥å…·åˆ—ï¼šç•™è¨€æ•¸ + æ’åºåˆ‡æ›æŒ‰éˆ•
    const toolbar = document.createElement('div');
    toolbar.className = 'flex items-center justify-between mb-3 pb-2 border-b';
    toolbar.innerHTML = `
        <span class="text-xs font-bold text-gray-400">${sorted.length} å‰‡ç•™è¨€</span>
        <button id="msg-sort-btn" class="text-xs px-3 py-1.5 bg-slate-100 text-slate-600 rounded-lg border hover:bg-slate-200 font-bold">
            ${msgSortDesc ? 'â¬‡ æœ€æ–°å„ªå…ˆ' : 'â¬† æœ€èˆŠå„ªå…ˆ'}
        </button>`;
    content.appendChild(toolbar);
    document.getElementById('msg-sort-btn').addEventListener('click', () => {
        msgSortDesc = !msgSortDesc;
        renderMessageListModal(bedId);
    });

    if (sorted.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'text-center text-gray-300 py-8 text-sm italic';
        empty.textContent = 'å°šç„¡ç•™è¨€';
        content.appendChild(empty);
    } else {
        const list = document.createElement('div');
        list.className = 'space-y-2';

        sorted.forEach(([msgId, msg]) => {
            const isUnread = currentRole === 'nursing' ? !msg.readByNursing
                           : currentRole === 'clerk'   ? !msg.readByClerk
                           : false; // æ§åˆ¶ç«¯ä¸å€åˆ†å·²è®€

            const timeStr = new Date(msg.time).toLocaleString('zh-TW', {
                month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
            });

            const item = document.createElement('div');
            item.className = `msg-item ${isUnread ? 'msg-unread' : 'msg-read'} bg-white rounded-xl border p-3`;

            // æ§åˆ¶ç«¯ + è­·ç†ç«¯ å…·å‚™ç·¨è¼¯/åˆªé™¤/å‚™è¨»æ¬Šé™ï¼›æ›¸è¨˜ç«¯å”¯è®€
            const canEdit = (currentRole === 'control' || currentRole === 'nursing');

            item.innerHTML = `
                <div class="flex items-start justify-between gap-2">
                    <div class="flex-1 min-w-0">
                        <div class="text-[10px] text-slate-400 mb-1 font-mono">${timeStr}</div>
                        <div class="msg-text text-sm leading-snug break-words">${escapeHtml(msg.text)}</div>
                        ${msg.note ? `<div class="msg-note-label mt-1.5">ğŸ“Œ ${escapeHtml(msg.note)}</div>` : ''}
                    </div>
                    ${canEdit ? `
                    <div class="flex flex-col gap-1 shrink-0">
                        <button data-action="edit"   data-id="${msgId}" data-bed="${bedId}"
                            class="text-[10px] px-2 py-1 bg-blue-50 text-blue-600 rounded-lg border border-blue-200 hover:bg-blue-100 font-bold whitespace-nowrap">âœï¸ ç·¨è¼¯</button>
                        <button data-action="note"   data-id="${msgId}" data-bed="${bedId}"
                            class="text-[10px] px-2 py-1 bg-yellow-50 text-yellow-600 rounded-lg border border-yellow-200 hover:bg-yellow-100 font-bold whitespace-nowrap">ğŸ“Œ å‚™è¨»</button>
                        <button data-action="delete" data-id="${msgId}" data-bed="${bedId}"
                            class="text-[10px] px-2 py-1 bg-red-50 text-red-500 rounded-lg border border-red-200 hover:bg-red-100 font-bold">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>` : ''}
                </div>`;
            list.appendChild(item);
        });
        content.appendChild(list);

        // ç¶å®šç·¨è¼¯ / å‚™è¨» / åˆªé™¤äº‹ä»¶
        content.querySelectorAll('[data-action="edit"]').forEach(btn => {
            btn.addEventListener('click', () => openMsgEditModal(btn.dataset.bed, btn.dataset.id, msgs[btn.dataset.id]?.text || ''));
        });
        content.querySelectorAll('[data-action="note"]').forEach(btn => {
            btn.addEventListener('click', () => openNoteEditModal(btn.dataset.bed, btn.dataset.id, msgs[btn.dataset.id]?.note || ''));
        });
        content.querySelectorAll('[data-action="delete"]').forEach(btn => {
            btn.addEventListener('click', () => {
                openConfirmModal('ç¢ºå®šåˆªé™¤æ­¤å‰‡ç•™è¨€ï¼Ÿ', () => {
                    remove(ref(db, `messages/${btn.dataset.bed}/${btn.dataset.id}`));
                    if (localMessages[btn.dataset.bed]) delete localMessages[btn.dataset.bed][btn.dataset.id];
                    refreshAllBadges();
                    renderMessageListModal(btn.dataset.bed);
                });
            });
        });
    }

    // æ§åˆ¶ç«¯ + è­·ç†ç«¯ åº•éƒ¨æ–°å¢ç•™è¨€æŒ‰éˆ•
    if (currentRole === 'control' || currentRole === 'nursing') {
        const addBtn = document.createElement('button');
        addBtn.className = 'w-full mt-3 py-2.5 bg-indigo-50 text-indigo-600 rounded-xl border border-indigo-200 font-bold hover:bg-indigo-100 transition text-sm';
        addBtn.textContent = 'ï¼‹ æ–°å¢ç•™è¨€';
        addBtn.addEventListener('click', () => { closeModal(); openNewMessageModal(bedId); });
        content.appendChild(addBtn);
    }

    showModal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šç·¨è¼¯ç•™è¨€å…§æ–‡ï¼ˆæ§åˆ¶ç«¯ + è­·ç†ç«¯ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openMsgEditModal(bedId, msgId, currentText) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = 'âœï¸ ç·¨è¼¯ç•™è¨€';
    content.innerHTML = `
        <textarea id="edit-msg-input"
            class="w-full border rounded-xl p-3 text-sm resize-none focus:ring-2 focus:ring-blue-400 outline-none"
            rows="4">${escapeHtml(currentText)}</textarea>
        <div class="flex gap-2 mt-2">
            <button id="edit-msg-ok"     class="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition text-sm">âœ“ å„²å­˜</button>
            <button id="edit-msg-cancel" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition text-sm">å–æ¶ˆ</button>
        </div>`;
    const inp = document.getElementById('edit-msg-input');
    setTimeout(() => { inp.focus(); inp.select(); }, 80);
    document.getElementById('edit-msg-ok').addEventListener('click', () => {
        const newText = inp.value.trim();
        if (newText) {
            dbUpdate({ [`/messages/${bedId}/${msgId}/text`]: newText });
            if (localMessages[bedId]?.[msgId]) localMessages[bedId][msgId].text = newText;
        }
        closeModal();
        setTimeout(() => openMessageListModal(bedId), 150);
    });
    document.getElementById('edit-msg-cancel').addEventListener('click', () => {
        closeModal();
        setTimeout(() => openMessageListModal(bedId), 150);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šå‚™è¨»ç·¨è¼¯ï¼ˆæ§åˆ¶ç«¯ + è­·ç†ç«¯ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openNoteEditModal(bedId, msgId, currentNote) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = 'ğŸ“Œ ç·¨è¼¯å‚™è¨»';
    content.innerHTML = `
        <textarea id="note-input"
            class="w-full border rounded-xl p-3 text-sm resize-none focus:ring-2 focus:ring-yellow-400 outline-none"
            rows="3" placeholder="è¼¸å…¥å‚™è¨»ï¼ˆç•™ç©ºå¯æ¸…é™¤ï¼‰â‹¯">${escapeHtml(currentNote)}</textarea>
        <div class="flex gap-2 mt-2">
            <button id="note-ok"     class="flex-1 py-2.5 bg-yellow-500 text-white rounded-xl font-bold hover:bg-yellow-600 transition text-sm">âœ“ å„²å­˜</button>
            <button id="note-cancel" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition text-sm">å–æ¶ˆ</button>
        </div>`;
    const inp = document.getElementById('note-input');
    setTimeout(() => { inp.focus(); inp.select(); }, 80);
    document.getElementById('note-ok').addEventListener('click', () => {
        dbUpdate({ [`/messages/${bedId}/${msgId}/note`]: inp.value.trim() });
        closeModal();
        setTimeout(() => openMessageListModal(bedId), 150);
    });
    document.getElementById('note-cancel').addEventListener('click', () => {
        closeModal();
        setTimeout(() => openMessageListModal(bedId), 150);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ç•™è¨€ Toastï¼ˆæ·±è—è‰²ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showMsgToast(bedId, text) {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = 'toast-in bg-indigo-700 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 border border-indigo-400 w-full pointer-events-auto cursor-pointer';
    t.innerHTML = `<span class="text-xl">ğŸ’¬</span>
        <div class="flex-1 min-w-0"><div class="text-[10px] opacity-75">æ–°ç•™è¨€ Â· ${bedId}</div><div class="text-sm font-bold truncate">${escapeHtml(text)}</div></div>
        <div class="text-lg opacity-50">âœ•</div>`;
    t.addEventListener('click', () => { t.classList.replace('toast-in','toast-out'); setTimeout(()=>t.remove(),300); });
    c.appendChild(t);
    setTimeout(() => { if (!t.classList.contains('toast-out')) { t.classList.replace('toast-in','toast-out'); setTimeout(()=>t.remove(),300); } }, 6000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HTML è½‰ç¾©ï¼ˆé˜²æ­¢ XSSï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šå»¶é²åŸå› ï¼ˆè­·ç†ç«¯å³éµ / é•·æŒ‰ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openReasonModal(bed) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = `â³ ${bed.id} å»¶é²åŸå› `;
    content.innerHTML = '';
    reasonList.forEach(reason => {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 rounded-xl border border-blue-200 text-blue-800 font-bold transition text-sm';
        btn.textContent = reason;
        btn.addEventListener('click', () => {
            dbUpdate({ [`/beds/${bed.id}/delayed`]: true, [`/beds/${bed.id}/delayReason`]: reason });
            closeModal();
        });
        content.appendChild(btn);
    });
    showModal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šåºŠä½ç®¡ç†ï¼ˆæ§åˆ¶ç«¯ç·¨è¼¯æ¨¡å¼é»æ“ŠåºŠå¡ï¼‰
   åŠŸèƒ½ï¼šç§»å‹•åˆ°åˆ†çµ„ / åˆªé™¤åºŠè™Ÿ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openBedEditModal(bed) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = `ğŸ›ï¸ åºŠè™Ÿ ${bed.id}`;
    content.innerHTML = '';
    const label = document.createElement('p');
    label.className = 'text-xs font-bold text-gray-400 mb-2 px-1 uppercase tracking-wider';
    label.textContent = 'ç§»å‹•åˆ°åˆ†çµ„';
    content.appendChild(label);
    getSortedGroups().forEach(group => {
        const isCurrent = (bed.groupId || 'default') === group.id;
        const btn = document.createElement('button');
        btn.className = `w-full text-left px-4 py-2.5 rounded-xl border mb-1.5 font-bold text-sm transition flex items-center justify-between
            ${isCurrent ? 'bg-indigo-500 text-white border-indigo-400 cursor-default' : 'bg-gray-50 hover:bg-gray-100 text-gray-700 border-gray-200'}`;
        btn.innerHTML = `<span>${group.name}</span>${isCurrent ? '<span class="text-xs opacity-75">âœ“ ç›®å‰</span>' : ''}`;
        if (!isCurrent) btn.addEventListener('click', () => { dbUpdate({ [`/beds/${bed.id}/groupId`]: group.id }); closeModal(); });
        content.appendChild(btn);
    });
    const sep = document.createElement('div');
    sep.className = 'border-t my-3';
    content.appendChild(sep);
    const isActive = bed.preDischarge || bed.readyForBilling || bed.billed || bed.delayed;
    if (!isActive) {
        const delBtn = document.createElement('button');
        delBtn.className = 'w-full py-2.5 bg-red-50 text-red-600 rounded-xl border border-red-200 font-bold hover:bg-red-100 text-sm';
        delBtn.textContent = `ğŸ—‘ï¸ åˆªé™¤åºŠè™Ÿ ${bed.id}`;
        delBtn.addEventListener('click', () => openConfirmModal(`ç¢ºå®šåˆªé™¤åºŠè™Ÿ ${bed.id}ï¼Ÿ`, () => remove(ref(db, `beds/${bed.id}`))));
        content.appendChild(delBtn);
    } else {
        const note = document.createElement('p');
        note.className = 'text-xs text-center text-gray-400 py-1';
        note.textContent = 'âš ï¸ åºŠè™Ÿæœ‰é€²è¡Œä¸­ç‹€æ…‹ï¼Œç„¡æ³•åˆªé™¤';
        content.appendChild(note);
    }
    showModal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šç¢ºèªæ“ä½œï¼ˆé€šç”¨ confirmï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openConfirmModal(message, onConfirm) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = 'ç¢ºèªæ“ä½œ';
    content.innerHTML = `
        <p class="text-center text-gray-700 py-3 font-medium text-sm leading-relaxed">${message}</p>
        <div class="flex gap-2">
            <button id="mc-ok"     class="flex-1 py-2.5 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">ç¢ºå®š</button>
            <button id="mc-cancel" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
        </div>`;
    document.getElementById('mc-ok').addEventListener('click', () => { onConfirm(); closeModal(); });
    document.getElementById('mc-cancel').addEventListener('click', closeModal);
    showModal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šç®¡ç†åˆ†çµ„ï¼ˆæ–°å¢ / æ’åº / æ”¹å / åˆªé™¤ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openGroupConfig() {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = 'ğŸ·ï¸ ç®¡ç†åˆ†çµ„';
    content.innerHTML = '';
    const addRow = document.createElement('div');
    addRow.className = 'flex gap-2 mb-3 pb-3 border-b';
    addRow.innerHTML = `
        <input id="new-group-name" class="border p-2 rounded-xl flex-grow text-sm focus:ring-2 focus:ring-purple-400 outline-none" placeholder="æ–°åˆ†çµ„åç¨±ï¼ˆå¦‚ï¼šAç—…æˆ¿ï¼‰">
        <button id="btn-add-group" class="bg-purple-500 text-white px-3 py-2 rounded-xl font-bold text-sm whitespace-nowrap hover:bg-purple-600 transition">æ–°å¢</button>`;
    content.appendChild(addRow);
    const sortedGroups = getSortedGroups();
    const listDiv = document.createElement('div');
    listDiv.className = 'space-y-1.5';
    sortedGroups.forEach((group, idx) => {
        const count = getBedsForGroup(group.id).length;
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 bg-gray-50 p-2.5 rounded-xl border';
        row.innerHTML = `
            <div class="flex-1 min-w-0">
                <div class="font-black text-gray-700 text-sm truncate">${group.name}</div>
                <div class="text-xs text-gray-400">${count} åºŠ</div>
            </div>
            <div class="flex gap-1 shrink-0">
                ${idx > 0
                    ? `<button data-up="${group.id}" class="w-7 h-7 bg-gray-200 rounded-lg hover:bg-gray-300 font-bold text-sm flex items-center justify-center">â†‘</button>`
                    : '<div class="w-7"></div>'}
                ${idx < sortedGroups.length - 1
                    ? `<button data-down="${group.id}" class="w-7 h-7 bg-gray-200 rounded-lg hover:bg-gray-300 font-bold text-sm flex items-center justify-center">â†“</button>`
                    : '<div class="w-7"></div>'}
                <button data-rename-g="${group.id}" data-name="${group.name}"
                        class="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 font-bold">æ”¹å</button>
                ${group.id !== 'default'
                    ? `<button data-del-g="${group.id}" class="text-xs px-2 py-1 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 font-bold">åˆªé™¤</button>`
                    : ''}
            </div>`;
        listDiv.appendChild(row);
    });
    content.appendChild(listDiv);
    document.getElementById('btn-add-group').addEventListener('click', () => {
        const input = document.getElementById('new-group-name');
        const name = input.value.trim();
        if (!name) return;
        const maxIdx = sortedGroups.length > 0 ? Math.max(...sortedGroups.map(g => g.index ?? 0)) : 0;
        set(ref(db, `groups/grp_${Date.now()}`), { name, index: maxIdx + 1 });
        closeModal();
    });
    listDiv.querySelectorAll('[data-up]').forEach(btn => btn.addEventListener('click', () => {
        const idx = sortedGroups.findIndex(g => g.id === btn.dataset.up);
        if (idx > 0) { dbUpdate({ [`/groups/${sortedGroups[idx].id}/index`]: sortedGroups[idx-1].index, [`/groups/${sortedGroups[idx-1].id}/index`]: sortedGroups[idx].index }); closeModal(); }
    }));
    listDiv.querySelectorAll('[data-down]').forEach(btn => btn.addEventListener('click', () => {
        const idx = sortedGroups.findIndex(g => g.id === btn.dataset.down);
        if (idx < sortedGroups.length - 1) { dbUpdate({ [`/groups/${sortedGroups[idx].id}/index`]: sortedGroups[idx+1].index, [`/groups/${sortedGroups[idx+1].id}/index`]: sortedGroups[idx].index }); closeModal(); }
    }));
    listDiv.querySelectorAll('[data-rename-g]').forEach(btn => btn.addEventListener('click', () => {
        openRenameGroupModal(btn.dataset.renameG, btn.dataset.name);
    }));
    listDiv.querySelectorAll('[data-del-g]').forEach(btn => btn.addEventListener('click', () => {
        confirmDeleteGroup({ id: btn.dataset.delG, ...groups[btn.dataset.delG] });
    }));
    showModal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šæ”¹ååˆ†çµ„
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openRenameGroupModal(id, oldName) {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = 'âœï¸ é‡æ–°å‘½ååˆ†çµ„';
    content.innerHTML = `
        <input id="rename-input" class="border p-2.5 rounded-xl w-full text-sm mb-3 focus:ring-2 focus:ring-blue-400 outline-none font-bold" value="${oldName}">
        <div class="flex gap-2">
            <button id="rn-ok"     class="flex-1 py-2.5 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition">ç¢ºå®š</button>
            <button id="rn-cancel" class="flex-1 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">å–æ¶ˆ</button>
        </div>`;
    const inp = content.querySelector('#rename-input');
    inp.focus(); inp.select();
    const confirm = () => { const n = inp.value.trim(); if (n) update(ref(db, `groups/${id}`), { name: n }); closeModal(); };
    content.querySelector('#rn-ok').addEventListener('click', confirm);
    content.querySelector('#rn-cancel').addEventListener('click', closeModal);
    inp.addEventListener('keydown', (e) => { if (e.key === 'Enter') confirm(); });
    showModal();
}

// åˆªé™¤åˆ†çµ„ç¢ºèªï¼ˆåºŠè™Ÿè‡ªå‹•ç§»è‡³æœªåˆ†çµ„ï¼‰
function confirmDeleteGroup(group) {
    const count = getBedsForGroup(group.id).length;
    openConfirmModal(
        `åˆªé™¤åˆ†çµ„ã€Œ${group.name}ã€ï¼Ÿ<br><span class="text-xs text-gray-400">${count > 0 ? `${count} å€‹åºŠè™Ÿå°‡ç§»è‡³ã€Œæœªåˆ†çµ„ã€` : 'æ­¤åˆ†çµ„ç„¡åºŠè™Ÿ'}</span>`,
        () => {
            const updates = { [`/groups/${group.id}`]: null };
            localBedList.filter(b => b.groupId === group.id).forEach(b => { updates[`/beds/${b.id}/groupId`] = 'default'; });
            dbUpdate(updates);
        }
    );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modalï¼šå»¶é²åŸå› è¨­å®šï¼ˆæ§åˆ¶ç«¯ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openReasonConfig() {
    const content = document.getElementById('modal-content');
    document.getElementById('modal-title').textContent = 'ğŸ“ ç·¨è¼¯å»¶é²åŸå› ';
    content.innerHTML = `
        <div class="flex gap-2 mb-3 pb-3 border-b">
            <input id="new-reason-input" class="border p-2 rounded-xl flex-grow text-sm focus:ring-2 focus:ring-sky-400 outline-none" placeholder="æ–°å¢åŸå› æ–‡å­—">
            <button id="btn-add-reason" class="bg-green-500 text-white px-3 py-2 rounded-xl font-bold text-sm whitespace-nowrap hover:bg-green-600 transition">æ–°å¢</button>
        </div>`;
    const listDiv = document.createElement('div');
    listDiv.className = 'space-y-1.5';
    const renderReasonList = () => {
        listDiv.innerHTML = '';
        reasonList.forEach((r, i) => {
            const row = document.createElement('div');
            row.className = 'flex justify-between items-center bg-gray-50 p-2.5 rounded-xl border';
            row.innerHTML = `<span class="font-bold text-gray-700 text-sm">${r}</span>`;
            const del = document.createElement('button');
            del.className = 'text-xs px-2.5 py-1 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 font-bold';
            del.textContent = 'åˆªé™¤';
            del.addEventListener('click', () => openConfirmModal('ç¢ºå®šåˆªé™¤æ­¤åŸå› ï¼Ÿ', () => {
                set(ref(db, 'reasons'), reasonList.filter((_,j) => j !== i));
            }));
            row.appendChild(del);
            listDiv.appendChild(row);
        });
    };
    renderReasonList();
    content.appendChild(listDiv);
    document.getElementById('btn-add-reason').addEventListener('click', () => {
        const inp = document.getElementById('new-reason-input');
        const val = inp.value.trim();
        if (val) { set(ref(db, 'reasons'), [...reasonList, val]); inp.value = ''; }
    });
    showModal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Modal å·¥å…·å‡½å¼
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showModal() {
    const m = document.getElementById('modal-container');
    m.classList.remove('hidden'); m.classList.add('flex');
}
function closeModal() {
    const m = document.getElementById('modal-container');
    m.classList.add('hidden'); m.classList.remove('flex');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   åˆ†çµ„ç¯©é¸ Tab åˆ—ï¼ˆå…©å€‹ä»¥ä¸Šåˆ†çµ„æ‰é¡¯ç¤ºï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateGroupFilterBar(sortedGroups) {
    const bar = document.getElementById('group-filter-bar');
    if (sortedGroups.length <= 1) { bar.classList.add('hidden'); return; }
    bar.classList.remove('hidden');
    bar.innerHTML = '';
    const makeTab = (label, val) => {
        const t = document.createElement('button');
        t.className = `group-tab shrink-0 px-3 py-1.5 rounded-xl border text-xs font-bold whitespace-nowrap ${selectedGroupFilter === val ? 'active' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'}`;
        t.textContent = label;
        t.addEventListener('click', () => { selectedGroupFilter = val; renderGrid(); });
        return t;
    };
    bar.appendChild(makeTab('å…¨éƒ¨', 'all'));
    sortedGroups.forEach(g => bar.appendChild(makeTab(`${g.name} (${getBedsForGroup(g.id).length})`, g.id)));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   åºŠä½ç®¡ç†ï¼ˆæ–°å¢ / æ¸…é™¤ï¼‰
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addBed() {
    const idInp  = document.getElementById('new-bed-id');
    const grpSel = document.getElementById('new-bed-group');
    const id = idInp.value.trim();
    if (!id) return;
    set(ref(db, `beds/${id}`), {
        type: 'bed', groupId: grpSel.value || 'default',
        preDischarge: false, readyForBilling: false,
        billed: false, delayed: false, delayReason: '', showClerkNote: false,
    });
    idInp.value = '';
    idInp.focus();
}

// åŒæ­¥åˆ†çµ„ä¸‹æ‹‰é¸å–®é¸é …
function updateGroupSelectOptions() {
    const sel = document.getElementById('new-bed-group');
    if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = '';
    getSortedGroups().forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id; opt.textContent = g.name;
        if (g.id === cur) opt.selected = true;
        sel.appendChild(opt);
    });
}

// æ¸…é™¤æ‰€æœ‰åºŠä½ç‹€æ…‹
function clearAllStatuses() {
    openConfirmModal('ç¢ºå®šè¦æ¸…é™¤ã€Œæ‰€æœ‰ã€ç‹€æ…‹ï¼Ÿ', () => {
        const updates = {};
        localBedList.forEach(b => {
            if (b.preDischarge)    updates[`/beds/${b.id}/preDischarge`]    = false;
            if (b.readyForBilling) updates[`/beds/${b.id}/readyForBilling`] = false;
            if (b.billed)          updates[`/beds/${b.id}/billed`]          = false;
            if (b.delayed)         updates[`/beds/${b.id}/delayed`]         = false;
            if (b.delayReason)     updates[`/beds/${b.id}/delayReason`]     = '';
            if (b.showClerkNote)   updates[`/beds/${b.id}/showClerkNote`]   = false;
        });
        if (Object.keys(updates).length) dbUpdate(updates);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   è§’è‰²åˆ‡æ›
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setRole(role) {
    currentRole = role;
    const map = {
        control: { label: 'æ§åˆ¶ç«¯', color: 'blue',   badge: 'bg-blue-100   text-blue-800'   },
        nursing: { label: 'è­·ç†ç«¯', color: 'green',  badge: 'bg-green-100  text-green-800'  },
        clerk:   { label: 'æ›¸è¨˜ç«¯', color: 'orange', badge: 'bg-orange-100 text-orange-800' },
    };
    ['control', 'nursing', 'clerk'].forEach(r => {
        const btn = document.getElementById(`btn-${r}`);
        btn.className = r === role
            ? `px-3 py-1.5 rounded-lg text-white font-bold shadow transition text-xs whitespace-nowrap bg-${map[r].color}-500`
            : 'px-3 py-1.5 rounded-lg bg-white text-gray-500 shadow transition hover:bg-gray-100 text-xs whitespace-nowrap';
    });
    const badge = document.getElementById('role-badge');
    badge.textContent = map[role].label;
    badge.className   = `text-xs px-2.5 py-1 rounded-lg font-bold ${map[role].badge}`;
    document.getElementById('admin-panel').classList.toggle('hidden',   role !== 'control');
    document.getElementById('nursing-panel').classList.toggle('hidden', role !== 'nursing');
    document.getElementById('clerk-panel').classList.toggle('hidden',   role !== 'clerk');
    renderGrid();
}

// åˆ‡æ›ç·¨è¼¯æ¨¡å¼ï¼ˆæ§åˆ¶ç«¯ï¼‰
function toggleEditMode() {
    isEditMode = !isEditMode;
    const btn   = document.getElementById('btn-edit-mode');
    const tools = document.getElementById('edit-tools');
    if (isEditMode) {
        btn.innerHTML = 'ğŸ”“ ç·¨è¼¯ä¸­';
        btn.className = 'shrink-0 bg-yellow-500 text-white px-3 py-1.5 rounded-lg font-bold shadow text-xs hover:bg-yellow-600 transition whitespace-nowrap';
        tools.classList.remove('hidden');
        updateGroupSelectOptions();
    } else {
        btn.innerHTML = 'ğŸ”’ é–å®šä¸­';
        btn.className = 'shrink-0 bg-gray-500 text-white px-3 py-1.5 rounded-lg font-bold shadow text-xs hover:bg-gray-600 transition whitespace-nowrap';
        tools.classList.add('hidden');
        _sortableInstances.forEach(s => s.destroy());
        _sortableInstances = [];
    }
    renderGrid();
}

// åˆ‡æ›é€šçŸ¥é–‹é—œ
function toggleNotify() {
    isNotifyEnabled = !isNotifyEnabled;
    const btn = document.getElementById('btn-notify-toggle');
    if (isNotifyEnabled) {
        btn.innerHTML = 'ğŸ”” é€šçŸ¥ï¼šé–‹å•Ÿ';
        btn.className = 'shrink-0 px-3 py-1.5 rounded-xl bg-green-100 text-green-700 border border-green-300 font-bold text-xs hover:bg-green-200 transition whitespace-nowrap';
    } else {
        btn.innerHTML = 'ğŸ”• éœéŸ³';
        btn.className = 'shrink-0 px-3 py-1.5 rounded-xl bg-gray-200 text-gray-500 border border-gray-300 font-bold text-xs hover:bg-gray-300 transition whitespace-nowrap';
        stopTitleFlash();
    }
}

// ä¾ç‹€æ…‹å–å¾—å°æ‡‰ CSS class
function getStatusClass(bed) {
    if (bed.billed)          return 'status-billed';
    if (bed.delayed)         return 'status-delayed';
    if (bed.readyForBilling) return 'status-ready';
    if (bed.preDischarge)    return 'status-pre-discharge';
    return 'status-normal';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOMContentLoadedï¼šç¶å®šæ‰€æœ‰æŒ‰éˆ•äº‹ä»¶ï¼Œä¾ URL åƒæ•¸åˆå§‹åŒ–è§’è‰²
   URL åƒæ•¸ï¼š?v=2 â†’ è­·ç†ç«¯ï¼›?v=3 â†’ æ›¸è¨˜ç«¯ï¼›é è¨­ â†’ æ§åˆ¶ç«¯
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btn-control').addEventListener('click', () => setRole('control'));
    document.getElementById('btn-nursing').addEventListener('click', () => setRole('nursing'));
    document.getElementById('btn-clerk').addEventListener('click',   () => setRole('clerk'));
    document.getElementById('btn-notify-toggle').addEventListener('click', toggleNotify);
    document.getElementById('btn-edit-mode').addEventListener('click', toggleEditMode);
    document.getElementById('btn-add-bed').addEventListener('click', addBed);
    document.getElementById('btn-group-config').addEventListener('click', openGroupConfig);
    document.getElementById('btn-reason-config').addEventListener('click', openReasonConfig);
    document.getElementById('btn-clear-all').addEventListener('click', clearAllStatuses);
    document.getElementById('modal-close-btn').addEventListener('click', closeModal);
    document.getElementById('new-bed-id').addEventListener('keydown', (e) => { if (e.key === 'Enter') addBed(); });
    document.addEventListener('visibilitychange', () => { if (!document.hidden) stopTitleFlash(); });
    document.getElementById('modal-container').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
    });
    const v = new URLSearchParams(window.location.search).get('v');
    if      (v === '2') setRole('nursing');
    else if (v === '3') setRole('clerk');
    else                setRole('control');
});
</script>
</body>
</html>
